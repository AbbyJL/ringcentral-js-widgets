{"version":3,"sources":["lib/OAuthBase/index.js"],"names":["OAuth","deps","dep","optional","alert","auth","brand","locale","tabManager","redirectUri","options","_alert","_auth","_brand","_locale","_tabManager","_redirectUri","resolve","location","href","_reducer","actionTypes","pending","ready","store","dispatch","type","init","initSuccess","callbackUri","code","login","message","accessDenied","internalError","danger","payload","enumMap","prefix","name","extendedQuery","stringify","force","localeId","currentLocale","ui_options","getLoginUrl","brandId","id","state","btoa","Date","now","display","status","oAuthReady"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from 'ringcentral-integration/lib/RcModule';\r\nimport { prefixEnum } from 'ringcentral-integration/lib/Enum';\r\nimport { Module } from 'ringcentral-integration/lib/di';\r\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\r\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\r\nimport parseCallbackUri from 'ringcentral-integration/lib/parseCallbackUri';\r\nimport popWindow from 'ringcentral-integration/lib/popWindow';\r\nimport required from 'ringcentral-integration/lib/required';\r\nimport qs from 'qs';\r\nimport url from 'url';\r\nimport baseActionTypes from './baseActionTypes';\r\nimport getOAuthBaseReducer from './getOAuthBaseReducer';\r\nimport oAuthMessages from './oAuthMessages';\r\n\r\n@Module({\r\n  deps: [\r\n    'Auth',\r\n    'Alert',\r\n    'Locale',\r\n    'Brand',\r\n    { dep: 'TabManager', optional: true },\r\n  ],\r\n})\r\nexport default class OAuth extends RcModule {\r\n  constructor({\r\n    alert,\r\n    auth,\r\n    brand,\r\n    locale,\r\n    tabManager,\r\n    redirectUri,\r\n    ...options\r\n  }) {\r\n    super({\r\n      ...options,\r\n    });\r\n    this._alert = this::ensureExist(alert, 'alert');\r\n    this._auth = this::ensureExist(auth, 'auth');\r\n    this._brand = this::ensureExist(brand, 'brand');\r\n    this._locale = this::ensureExist(locale, 'locale');\r\n    this._tabManager = tabManager;\r\n    this._redirectUri = url.resolve(location.href, this::ensureExist(redirectUri, 'redirectUri'));\r\n    this._reducer = getOAuthBaseReducer(this.actionTypes);\r\n  }\r\n\r\n  get _actionTypes() {\r\n    return prefixEnum({ enumMap: baseActionTypes, prefix: this.name });\r\n  }\r\n\r\n  @required\r\n  get name() {\r\n    /* require implementation in descendent */\r\n  }\r\n\r\n  _onStateChange() {\r\n    if (\r\n      this.pending &&\r\n      (\r\n        this._auth.ready &&\r\n        this._locale.ready &&\r\n        this._alert.ready &&\r\n        (!this._tabManager || this._tabManager.ready)\r\n      )\r\n    ) {\r\n      this.store.dispatch({\r\n        type: this.actionTypes.init,\r\n      });\r\n      this.store.dispatch({\r\n        type: this.actionTypes.initSuccess,\r\n      });\r\n    }\r\n  }\r\n\r\n  @proxify\r\n  async _handleCallbackUri(callbackUri) {\r\n    try {\r\n      const code = parseCallbackUri(callbackUri);\r\n      if (code) {\r\n        await this._auth.login({\r\n          code,\r\n          redirectUri: this.redirectUri,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      let message;\r\n      switch (error.message) {\r\n        case 'invalid_request':\r\n        case 'unauthorized_client':\r\n        case 'access_denied':\r\n        case 'unsupported_response_type':\r\n        case 'invalid_scope':\r\n          message = oAuthMessages.accessDenied;\r\n          break;\r\n        case 'server_error':\r\n        case 'temporarily_unavailable':\r\n        default:\r\n          message = oAuthMessages.internalError;\r\n          break;\r\n      }\r\n      this._alert.danger({\r\n        message,\r\n        payload: error,\r\n      });\r\n    }\r\n  }\r\n\r\n  @required\r\n  async prepareOAuth() {}\r\n\r\n  @required\r\n  async destroyOAuth() {}\r\n\r\n  @required\r\n  openOAuthPage() {}\r\n\r\n\r\n  get oAuthUri() {\r\n    const extendedQuery = qs.stringify({\r\n      force: true,\r\n      localeId: this._locale.currentLocale,\r\n      ui_options: 'hide_remember_me hide_tos',\r\n    });\r\n    return `${this._auth.getLoginUrl({\r\n      redirectUri: this.redirectUri,\r\n      brandId: this._brand.id,\r\n      state: btoa(Date.now()),\r\n      display: 'page',\r\n    })}&${extendedQuery}`;\r\n  }\r\n\r\n  get status() {\r\n    return this.state.status;\r\n  }\r\n\r\n  get oAuthReady() {\r\n    return this.state.oAuthReady;\r\n  }\r\n\r\n  get redirectUri() {\r\n    return url.resolve(location.href, this._redirectUri);\r\n  }\r\n}\r\n"]}