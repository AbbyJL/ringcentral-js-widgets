{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["getProxyClient","Target","transport","options","actionTypes","_id","v4","_target","getState","state","target","getProxyState","proxy","_transport","_setTransport","subModule","Object","prototype","hasOwnProperty","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action"],"mappings":"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","file":"getProxyClient.js","sourcesContent":["import uuid from 'uuid';\nimport RcModule from '../RcModule';\nimport getProxyClientReducer from './getProxyClientReducer';\nimport baseActionTypes from './baseActionTypes';\nimport ensureExist from '../ensureExist';\n\n\nexport default function getProxyClient(Target) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._id = uuid.v4();\n      this._target = new Target({\n        ...options,\n        getState: () => this.state.target,\n        getProxyState: () => this.state.proxy,\n      });\n      this._transport = this::ensureExist(transport, 'transport');\n      this._setTransport(this._target);\n      for (const subModule in this._target) {\n        if (\n          this._target::Object.prototype.hasOwnProperty(subModule) &&\n            this._target[subModule] instanceof RcModule\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n        }\n      }\n\n      this._reducer = getProxyClientReducer({\n        targetReducer: this._target.reducer,\n        proxyReducer: this._target.proxyReducer,\n        transport,\n        types: this.actionTypes,\n      });\n    }\n\n    _setTransport(target) {\n      target._transport = this._transport;\n      target._proxyActionTypes = this.actionTypes;\n      target._suppressInit = true;\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n            target[subModule] instanceof RcModule\n        ) {\n          this._setTransport(target[subModule]);\n        }\n      }\n    }\n\n\n    async _sync() {\n      try {\n        const result = await this._transport.request({\n          payload: {\n            type: this.actionTypes.sync,\n            actionNumber: this.state.actionNumber\n          },\n        });\n        this.store.dispatch({\n          ...result,\n          type: this.actionTypes.sync,\n        });\n      } catch (_) { /* Ignore */ }\n      this._syncPromise = null;\n    }\n    sync() {\n      if (!this._syncPromise) {\n        this._syncPromise = this._sync();\n      }\n      return this._syncPromise;\n    }\n\n    _initialize(target) {\n      if (\n        typeof target.initializeProxy === 'function' &&\n        !target._proxyInitialized\n      ) {\n        target._proxyInitialized = true;\n        target.initializeProxy();\n      }\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n            target[subModule] instanceof RcModule\n        ) {\n          this._initialize(target[subModule]);\n        }\n      }\n    }\n    async initialize() {\n      // initialize the instance before sync to avoid history object from\n      // becoming out of sync\n      this._initialize(this._target);\n      this._transport.on(this._transport.events.push, async (payload) => {\n        if (payload.type === this.actionTypes.action) {\n          if (this._syncPromise) await this._syncPromise;\n          if (payload.actionNumber === this.state.actionNumber + 1) {\n            this.store.dispatch({\n              ...payload,\n              type: this.actionTypes.action,\n            });\n          } else {\n            await this.sync();\n          }\n        }\n      });\n      await this.sync();\n    }\n  };\n}\n"]}