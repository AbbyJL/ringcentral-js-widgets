{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["getProxyClient","Target","transport","options","actionTypes","baseActionTypes","_id","uuid","v4","_target","getState","state","target","getProxyState","proxy","_transport","ensureExist","_setTransport","subModule","Object","prototype","hasOwnProperty","RcModule","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action"],"mappings":"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","file":"getProxyClient.js","sourcesContent":["import uuid from 'uuid';\nimport RcModule from '../RcModule';\nimport getProxyClientReducer from './getProxyClientReducer';\nimport baseActionTypes from './baseActionTypes';\nimport ensureExist from '../ensureExist';\n\n\nexport default function getProxyClient(Target) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._id = uuid.v4();\n      this._target = new Target({\n        ...options,\n        getState: () => this.state.target,\n        getProxyState: () => this.state.proxy,\n      });\n      this._transport = this::ensureExist(transport, 'transport');\n      this._setTransport(this._target);\n      for (const subModule in this._target) {\n        if (\n          this._target::Object.prototype.hasOwnProperty(subModule) &&\n            this._target[subModule] instanceof RcModule\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n        }\n      }\n\n      this._reducer = getProxyClientReducer({\n        targetReducer: this._target.reducer,\n        proxyReducer: this._target.proxyReducer,\n        transport,\n        types: this.actionTypes,\n      });\n    }\n\n    _setTransport(target) {\n      target._transport = this._transport;\n      target._proxyActionTypes = this.actionTypes;\n      target._suppressInit = true;\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n            target[subModule] instanceof RcModule\n        ) {\n          this._setTransport(target[subModule]);\n        }\n      }\n    }\n\n\n    async _sync() {\n      try {\n        const result = await this._transport.request({\n          payload: {\n            type: this.actionTypes.sync,\n            actionNumber: this.state.actionNumber\n          },\n        });\n        this.store.dispatch({\n          ...result,\n          type: this.actionTypes.sync,\n        });\n      } catch (_) { /* Ignore */ }\n      this._syncPromise = null;\n    }\n    sync() {\n      if (!this._syncPromise) {\n        this._syncPromise = this._sync();\n      }\n      return this._syncPromise;\n    }\n\n    _initialize(target) {\n      if (\n        typeof target.initializeProxy === 'function' &&\n        !target._proxyInitialized\n      ) {\n        target._proxyInitialized = true;\n        target.initializeProxy();\n      }\n      for (const subModule in target) {\n        if (\n          target::Object.prototype.hasOwnProperty(subModule) &&\n            target[subModule] instanceof RcModule\n        ) {\n          this._initialize(target[subModule]);\n        }\n      }\n    }\n    async initialize() {\n      // initialize the instance before sync to avoid history object from\n      // becoming out of sync\n      this._initialize(this._target);\n      this._transport.on(this._transport.events.push, async (payload) => {\n        if (payload.type === this.actionTypes.action) {\n          if (this._syncPromise) await this._syncPromise;\n          if (payload.actionNumber === this.state.actionNumber + 1) {\n            this.store.dispatch({\n              ...payload,\n              type: this.actionTypes.action,\n            });\n          } else {\n            await this.sync();\n          }\n        }\n      });\n      await this.sync();\n    }\n  };\n}\n"]}