{"version":3,"sources":["lib/AdapterModuleCore/index.js"],"names":["AdapterModuleCore","prefix","storageKey","messageTypes","actionTypes","presence","locale","routerInteraction","globalStorage","getGlobalStorageReducer","messageTransport","targetWindow","window","parent","options","_messageTypes","enumMap","_locale","_messageTransport","_presence","_router","_storageKey","_globalStorage","registerReducer","key","reducer","addListener","_onMessage","msg","store","subscribe","_onStateChange","pending","ready","_shouldInit","dispatch","type","init","_pushAdapterState","initSuccess","_pushPresence","_pushLocale","syncClosed","_syncClosed","closed","syncMinimized","_syncMinimized","minimized","syncSize","_syncSize","size","syncPosition","_syncPosition","position","presenceClicked","_onPresenceClicked","acitonTypes","_lastDndStatus","dndStatus","_lastUserStatus","userStatus","_lastTelephonyStatus","telephonyStatus","_postMessage","pushPresence","_lastLocale","currentLocale","pushLocale","strings","_localeStrings","data","postMessage","_lastClosed","_lastMinimized","_lastPosition","pushAdapterState","showAdapter","push","state","status","getItem"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from 'ringcentral-integration/lib/RcModule';\r\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\r\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\r\nimport moduleStatuses from 'ringcentral-integration/enums/moduleStatuses';\r\nimport { prefixEnum } from 'ringcentral-integration/lib/Enum';\r\nimport baseMessageTypes from '../AdapterCore/baseMessageTypes';\r\nimport baseActionTypes from './baseActionTypes';\r\nimport getDefaultGlobalStorageReducer from './getDefaultGlobalStorageReducer';\r\nimport IframeMessageTransport from '../IframeMessageTransport';\r\n\r\n\r\nexport default class AdapterModuleCore extends RcModule {\r\n  constructor({\r\n    prefix,\r\n    storageKey = 'adapterCore',\r\n    messageTypes = baseMessageTypes,\r\n    actionTypes = baseActionTypes,\r\n    presence,\r\n    locale,\r\n    routerInteraction,\r\n    globalStorage,\r\n    getGlobalStorageReducer = getDefaultGlobalStorageReducer,\r\n    messageTransport = new IframeMessageTransport({\r\n      targetWindow: window.parent,\r\n    }),\r\n    ...options\r\n  }) {\r\n    super({\r\n      prefix,\r\n      actionTypes,\r\n      ...options,\r\n    });\r\n\r\n    this._messageTypes = prefixEnum({ enumMap: messageTypes, prefix });\r\n    this._locale = this::ensureExist(locale, 'locale');\r\n    this._messageTransport = this::ensureExist(messageTransport, 'messageTransport');\r\n    this._presence = this::ensureExist(presence, 'presence');\r\n    this._router = this::ensureExist(routerInteraction, 'routerInteraction');\r\n\r\n    this._storageKey = storageKey;\r\n    this._globalStorage = this::ensureExist(globalStorage, 'globalStorage');\r\n\r\n    this._globalStorage.registerReducer({\r\n      key: this._storageKey,\r\n      reducer: getGlobalStorageReducer(this.actionTypes),\r\n    });\r\n  }\r\n  initialize() {\r\n    this._messageTransport.addListener(msg => this._onMessage(msg));\r\n    this.store.subscribe(() => this._onStateChange());\r\n  }\r\n  _shouldInit() {\r\n    return this.pending &&\r\n      this._globalStorage.ready &&\r\n      this._locale.ready &&\r\n      this._router.ready;\r\n  }\r\n  _onStateChange() {\r\n    if (this._shouldInit()) {\r\n      this.store.dispatch({\r\n        type: this.actionTypes.init,\r\n      });\r\n      this._pushAdapterState();\r\n      this.store.dispatch({\r\n        type: this.actionTypes.initSuccess,\r\n      });\r\n    }\r\n    this._pushPresence();\r\n    this._pushLocale();\r\n  }\r\n  _onMessage(msg) {\r\n    if (msg) {\r\n      switch (msg.type) {\r\n        case this._messageTypes.syncClosed:\r\n          this._syncClosed(msg.closed);\r\n          break;\r\n        case this._messageTypes.syncMinimized:\r\n          this._syncMinimized(msg.minimized);\r\n          break;\r\n        case this._messageTypes.syncSize:\r\n          this._syncSize(msg.size);\r\n          break;\r\n        case this._messageTypes.syncPosition:\r\n          this._syncPosition(msg.position);\r\n          break;\r\n        case this._messageTypes.presenceClicked:\r\n          this._onPresenceClicked();\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n  }\r\n  @proxify\r\n  async _syncClosed(closed) {\r\n    this.store.dispatch({\r\n      type: this.actionTypes.syncClosed,\r\n      closed,\r\n    });\r\n  }\r\n  @proxify\r\n  async _syncMinimized(minimized) {\r\n    this.store.dispatch({\r\n      type: this.actionTypes.syncMinimized,\r\n      minimized,\r\n    });\r\n  }\r\n  @proxify\r\n  async _syncSize(size = {}) {\r\n    this.store.dispatch({\r\n      type: this.acitonTypes.syncSize,\r\n      size,\r\n    });\r\n  }\r\n  @proxify\r\n  async _syncPosition(position = {}) {\r\n    this.store.dispatch({\r\n      type: this.actionTypes.syncPosition,\r\n      position,\r\n    });\r\n  }\r\n  _pushPresence() {\r\n    if (\r\n      this.ready &&\r\n      (\r\n        this._lastDndStatus !== this._presence.dndStatus ||\r\n        this._lastUserStatus !== this._presence.userStatus ||\r\n        this._lastTelephonyStatus !== this._presence.telephonyStatus\r\n      )\r\n    ) {\r\n      this._lastDndStatus = this._presence.dndStatus;\r\n      this._lastUserStatus = this._presence.userStatus;\r\n      this._lastTelephonyStatus = this._presence.telephonyStatus;\r\n      this._postMessage({\r\n        type: this._messageTypes.pushPresence,\r\n        telephonyStatus: this._presence.telephonyStatus,\r\n        userStatus: this._presence.userStatus,\r\n        dndStatus: this._presence.dndStatus,\r\n      });\r\n    }\r\n  }\r\n\r\n  get localeStrings() {\r\n    return {};\r\n  }\r\n\r\n  _pushLocale() {\r\n    if (\r\n      this.ready &&\r\n      this._lastLocale !== this._locale.currentLocale\r\n    ) {\r\n      this._lastLocale = this._locale.currentLocale;\r\n      this._postMessage({\r\n        type: this._messageTypes.pushLocale,\r\n        locale: this._locale.currentLocale,\r\n        strings: this._localeStrings,\r\n      });\r\n    }\r\n  }\r\n\r\n  _postMessage(data) {\r\n    this._messageTransport.postMessage(data);\r\n  }\r\n\r\n  _pushAdapterState() {\r\n    if (\r\n      this.ready &&\r\n      (\r\n        this._lastDndStatus !== this._presence.dndStatus ||\r\n        this._lastUserStatus !== this._presence.userStatus ||\r\n        this._lastTelephonyStatus !== this._presence.telephonyStatus ||\r\n        this._lastClosed !== this.closed ||\r\n        this._lastMinimized !== this.minimized ||\r\n        this._lastPosition !== this.position\r\n      )\r\n    ) {\r\n      this._lastDndStatus = this._presence.dndStatus;\r\n      this._lastUserStatus = this._presence.userStatus;\r\n      this._lastTelephonyStatus = this._presence.telephonyStatus;\r\n      this._lastClosed = this.closed;\r\n      this._lastMinimized = this.minimized;\r\n      this._lastPosition = this.position;\r\n      this._postMessage({\r\n        type: this._messageTypes.pushAdapterState,\r\n        size: this.size,\r\n        minimized: this.minimized,\r\n        closed: this.closed,\r\n        position: this.position,\r\n        telephonyStatus: this._presence.telephonyStatus,\r\n        userStatus: this._presence.userStatus,\r\n        dndStatus: this._presence.dndStatus,\r\n      });\r\n    }\r\n  }\r\n  @proxify\r\n  async _onPresenceClicked() {\r\n    if (this.minimized) {\r\n      this.showAdapter();\r\n    }\r\n    this._router.push('/settings?showPresenceSettings=1');\r\n  }\r\n\r\n  @proxify\r\n  async showAdapter() {\r\n    this.store.dispatch({\r\n      type: this.actionTypes.showAdapter,\r\n    });\r\n  }\r\n\r\n  get status() {\r\n    return this.state.status;\r\n  }\r\n  get ready() {\r\n    return this.status === moduleStatuses.ready;\r\n  }\r\n\r\n  get pending() {\r\n    return this.status === moduleStatuses.pending;\r\n  }\r\n\r\n  get minimized() {\r\n    return this._globalStorage.getItem(this._storageKey).minimized;\r\n  }\r\n  get closed() {\r\n    return this._globalStorage.getItem(this._storageKey).closed;\r\n  }\r\n  get size() {\r\n    return this._globalStorage.getItem(this._storageKey).size;\r\n  }\r\n  get position() {\r\n    return this._globalStorage.getItem(this._storageKey).position;\r\n  }\r\n}\r\n"]}