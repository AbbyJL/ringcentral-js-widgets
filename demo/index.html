<!DOCTYPE html>
<html>

<head>
    <title>RingCentral Web Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../src/styles/normalize.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/main.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/call-log.css">
    <link rel="stylesheet" type="text/css" href="theme/blue.css" id="theme-css">
    <style type="text/css">
    html {
        height: 100%;
    }
    
    body {
        width: 250px;
        height: 100%;
        border-right: 1px solid #878787;
    }
    </style>
</head>

<body>
    <div id='phone'>
        <div id="auth-panel"></div>
        <div id="dial-pad"></div>
        <div id="call-panel"></div>
        <div id="call-log-panel"></div>
    </div>
    <script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
    <script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
    <script type="text/javascript" src="../build/build.js"></script>
    <script type="text/javascript">
    var authPanel;
    var dialPad;
    w.config({
        path: '../template/'
    })
    w('auth-panel', {
        actions: {
            login: {
                method: function() {
                    var username = this.props.dom.username.value;
                    var extension = this.props.dom.extension.value;
                    var password = this.props.dom.password.value;
                    return LoginService.login(username, extension, password);
                },
                after: function() {
                    var authPanel = this;
                    w('dial-pad', {
                        actions: {
                            render: {
                                before: function() {
                                    authPanel.remove();
                                }
                            },
                            getCandidates: {
                                method: function() {
                                    return CallLogService.getCallLogs();
                                }
                            },
                            callout: {
                                method: function(fromNo, toNo) {
                                    return PhoneService.callout(fromNo, toNo);
                                }
                            }
                        }
                    }).then(widget => widget.render('#dial-pad'));
                    w('call-panel', {
                        actions: {
                            init: {
                                after: function() {
                                    PhoneService.initPhoneListener();
                                }
                            }
                        },
                        handlers: {
                            called: {
                                method: function(handler) {
                                    console.log('called');
                                    PhoneService.called(handler);
                                }
                            },
                            callStarted: {
                                method: function(handler) {
                                    PhoneService.callStarted(handler);
                                }
                            },
                            callRejected: {
                                method: function(handler) {
                                    PhoneService.callRejected(handler);
                                }
                            },
                            callEnded: {
                                method: function(handler) {
                                    PhoneService.callEnded(handler);
                                }
                            },
                            callFailed: {
                                method: function(handler) {
                                    PhoneService.callFailed(handler);
                                }
                            }
                        }
                    })
                    .then(widget => widget.render('#call-panel'))
                    .catch(err => console.error(err));
                }
            }
        },
        handlers: {},
    }).then(widget => {
        authPanel = widget;
        authPanel.render('#auth-panel');
    })
    LoginService.registerLoginHandler(function() {
        PhoneService.registerSIP();
        CallLogService.getCallLogs();
    });

    // LoginService.checkLoginStatus().then(

    //     function(isLoggedIn) {
    //         if (isLoggedIn) {

    //             callPanel.render('#call-panel');
    //             dialPad.render('#dial-pad');
    //             callLog.render('#call-log-panel');

    //         } else {
    //             // render is async, supports both callbacks and promises
    //             authPanel.render('#auth-panel', function() { /* ... */ });
    //         }
    //     }

    // );
    </script>
</body>

</html>
