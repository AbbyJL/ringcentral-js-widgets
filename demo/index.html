<!DOCTYPE html>
<html>

<head>
    <title>RingCentral Web Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="normalize.css">
    <link rel="stylesheet" type="text/css" href="main.css">
    <link rel="stylesheet" type="text/css" href="theme/basic.css" id="theme-css">
    <style type="text/css">
    body {
        max-width: 250px;
    }
    
    .theme-panel {
        margin-bottom: 10px;
    }
    
    .theme-button {
        border: 0;
        width: 20px;
        height: 20px;
        border: 1px solid;
    }
    
    #theme-basic {
        background-color: #fff;
        border-color: #000;
    }
    
    #theme-blue {
        background-color: #3498db;
    }
    
    #theme-casual {
        background-color: #95a5a6;
    }
    </style>
</head>

<body>
    <div class='theme-panel'>
        Theme:
        <button class='theme-button' id='theme-basic' onclick="switchTheme('basic')"></button>
        <button class='theme-button' id='theme-blue' onclick="switchTheme('blue')"></button>
        <button class='theme-button' id='theme-casual' onclick="switchTheme('casual')"></button>
    </div>
    <div>
        <div id="auth-panel">
            <div class='rc-panel'>
                <input class='rc-input' data-info='server' placeholder="server"></input>
                <input class='rc-input' data-info='key' placeholder="key"></input>
                <input class='rc-input' data-info='secret' placeholder="secret"></input>
                <input class='rc-input' data-info='username' placeholder="username"></input>
                <input class='rc-input' data-info='extension' placeholder="extension"></input>
                <input class='rc-input' data-info='password' placeholder="password"></input>
                <button class='rc-button' data-info='login' data-action='login' data-event='click'>login</button>
                <div class='rc-error-message' data-info='error' data-show='error'></div>
            </div>
        </div>
        <div id="dial-pad">
            <div class='rc-panel'>
                <input class='rc-input' data-info='number'>
                <div class='rc-dial-wrapper'>
                    <button class='rc-dial-button' data-action='dial-1' data-value='1'>1</button>
                    <button class='rc-dial-button' data-action='dial-2' data-value='2'>2</button>
                    <button class='rc-dial-button' data-action='dial-3' data-value='3'>3</button>
                    <button class='rc-dial-button' data-action='dial-4' data-value='4'>4</button>
                    <button class='rc-dial-button' data-action='dial-5' data-value='5'>5</button>
                    <button class='rc-dial-button' data-action='dial-6' data-value='6'>6</button>
                    <button class='rc-dial-button' data-action='dial-7' data-value='7'>7</button>
                    <button class='rc-dial-button' data-action='dial-8' data-value='8'>8</button>
                    <button class='rc-dial-button' data-action='dial-9' data-value='9'>9</button>
                    <button class='rc-dial-button' data-action='dial-0' data-value='0'>0</button>
                </div>
                <button class='rc-button' data-action='callout'>Call out</button>
                <button id='custom-btn'> my custom call out button</button>
                <div class='rc-error-message'></div>
                </input>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
    <script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
    <script type="text/javascript" src="../build/build.js"></script>
    <script type="text/javascript">
    var ringCentralAction = function() {
        var sdk;
        var webPhone;
        return {
            login: function(dom) {
                sdk = new RingCentral.SDK({
                    appKey: dom.key.value,
                    appSecret: dom.secret.value,
                    server: dom.server.value || RingCentral.SDK.server.production
                });
                return sdk.platform()
                    .login({
                        username: dom.username.value,
                        extension: dom.extension.value,
                        password: dom.password.value
                    })
                    .then(() => registerSIP())


                function registerSIP() {
                    webPhone = new RingCentral.WebPhone({
                        audioHelper: {
                            incoming: '../demo/audio/incoming.ogg',
                            outgoing: '../demo/audio/outgoing.ogg'
                        }
                    });
                    return sdk.platform()
                        .post('/client-info/sip-provision', {
                            sipInfo: [{
                                transport: 'WSS'
                            }]
                        })
                        .then(res => {
                            var data = res.json();
                            console.log("Sip Provisioning Data from RC API: " + JSON.stringify(data));
                            console.log(data.sipFlags.outboundCallsEnabled);
                            var checkFlags = false;
                            return webPhone.register(data, checkFlags)
                                .then(function() {
                                    console.log('Registered');
                                })
                                .catch(function(e) {
                                    return Promise.reject(err);
                                });

                        }).catch(e => {
                            console.error(e);
                            return Promise.reject(e);
                        });
                }
            },
            callout: function(dom, options) {
                console.log(options);
                var toNumber = options.toNumber;
                var fromNumber = localStorage.getItem('username');

                // TODO: validate toNumber and fromNumber
                if (!sdk || !webPhone) {
                    throw Error('Need to set up SDK and webPhone first.');
                    return;
                }
                return sdk.platform()
                    .get('/restapi/v1.0/account/~/extension/~')
                    .then(res => {
                        console.log(res);
                        var info = res.json();
                        if (info && info.regionalSettings && info.regionalSettings.homeCountry) {
                            return info.regionalSettings.homeCountry.id;
                        }
                        return null;
                    })
                    .then(countryId => {
                        webPhone.call(toNumber, fromNumber, countryId);
                    })
                    .catch(e => {
                        console.error(e);
                        this.element.panel.errorMessage.textContent = e.message;
                        if (this.interval) {
                            this.interval.cancel('Call');
                            this.interval = null;
                        }
                    });
            }
        }
    }();

    var authPanel = new AuthPanel({
        target: '#auth-panel',
        actions: {
            login: function(dom) {
                return ringCentralAction.login(dom);
            },
            signup: function(dom) {}
        },
        listeners: {
            afterLogin: function() {
                var dialPad = new DialPad({
                    target: '#dial-pad',
                    actions: {
                        callout: function(dom, options) {
                            return ringCentralAction.callout(dom, options);
                        }
                    }
                })
                document.getElementById('custom-btn').addEventListener('click', function(e) {
                    ringCentralAction.callout(null, options);
                    dialPad.callout();
                });
            }
        }
    });
    

    function switchTheme(theme) {
        document.getElementById('theme-css').href = 'theme/' + theme + '.css';
    }
    </script>
</body>

</html>
