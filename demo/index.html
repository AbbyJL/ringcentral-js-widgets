<!DOCTYPE html>
<html>

<head>
    <title>RingCentral Web Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../src/styles/normalize.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/main.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/call-log.css">
    <link rel="stylesheet" type="text/css" href="theme/blue.css" id="theme-css">
    <style type="text/css">
    html {
        height: 100%;
    }
    
    body {
        width: 250px;
        height: 100%;
        border-right: 1px solid #878787;
    }
    </style>
</head>

<body>
    <div id='phone'>
        <div id="auth-panel"></div>
        <div id="dial-pad"></div>
        <div id="call-panel"></div>
        <div id="call-log-panel"></div>
    </div>
    <script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
    <script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
    <script type="text/javascript" src="../build/build.js"></script>
    <script type="text/javascript">
    w.config({
        path: '../template/',
        preload: ['auth-panel', 'dial-pad', 'call-panel']
    }, init)

    function init() {
        var authPanel = w('auth-panel', {
            actions: {
                login: {
                    method: function() {
                        var username = this.props.username;
                        var extension = this.props.extension;
                        var password = this.props.password;
                        return LoginService.login(username, extension, password);
                    },
                    after: function() {
                        var authPanel = this;
                        dialPad.render('#dial-pad', function() {
                            authPanel.remove();
                        });
                        callPanel.render('#call-panel');
                    }
                }
            },
            handlers: {},
        })
        var dialPad = w('dial-pad', {
            actions: {
                getCandidates: {
                    method: function() {
                        return CallLogService.getCallLogs();
                    }
                },
                callout: {
                    method: function(fromNo, toNo) {
                        return PhoneService.callout(fromNo, toNo);
                    }
                }
            }
        })
        var callPanel = w('call-panel', {
            actions: {
                init: {
                    after: function() {
                        PhoneService.initPhoneListener();
                        PhoneService.on('called', this.called);
                        PhoneService.on('callStarted', this.callStarted);
                        PhoneService.on('callRejected', this.callRejected);
                        PhoneService.on('callEnded', this.callEnded);
                        PhoneService.on('callFailed', this.callFailed);
                    }
                },
                answer: {
                    method: function() {
                        PhoneService.answer();
                    }
                },
                hangup: {
                    method: function() {
                        PhoneService.hangup();
                    }
                }
            }
        })
        LoginService.checkLoginStatus().then(
            isLoggedIn => {
                if (isLoggedIn) {
                    dialPad.render('#dial-pad');
                    callPanel.render('#call-panel');
                } else
                    authPanel.render('#auth-panel');
            }
        );
    }

    LoginService.registerLoginHandler(function() {
        PhoneService.registerSIP();
        CallLogService.getCallLogs();
    });
    </script>
</body>

</html>
