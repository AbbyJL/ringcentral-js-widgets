<!DOCTYPE html>
<html>

<head>
    <title>RingCentral Web Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="normalize.css">
    <link rel="stylesheet" type="text/css" href="main.css">
    <link rel="stylesheet" type="text/css" href="theme/basic.css" id="theme-css">
    <style type="text/css">
    body {
        max-width: 250px;
    }
    
    .theme-panel {
        margin-bottom: 10px;
    }
    
    .theme-button {
        border: 0;
        width: 20px;
        height: 20px;
        border: 1px solid;
    }
    
    #theme-basic {
        background-color: #fff;
        border-color: #000;
    }
    
    #theme-blue {
        background-color: #3498db;
    }
    
    #theme-casual {
        background-color: #95a5a6;
    }
    </style>
</head>

<body>
    <div class='theme-panel'>
        Theme:
        <button class='theme-button' id='theme-basic' onclick="switchTheme('basic')"></button>
        <button class='theme-button' id='theme-blue' onclick="switchTheme('blue')"></button>
        <button class='theme-button' id='theme-casual' onclick="switchTheme('casual')"></button>
    </div>
    <div>
        <div id="auth-panel">
            <div class='rc-panel'>
                <input class='rc-input' data-info='server' placeholder="server"></input>
                <input class='rc-input' data-info='key' placeholder="key"></input>
                <input class='rc-input' data-info='secret' placeholder="secret"></input>
                <input class='rc-input' data-info='username' placeholder="username"></input>
                <input class='rc-input' data-info='extension' placeholder="extension"></input>
                <input class='rc-input' data-info='password' placeholder="password"></input>
                <button class='rc-button' data-action='login'>login</button>
                <div class='rc-error-message' data-show='error'></div>
            </div>
        </div>
        <!--  <div id="dial-pad"></div>
        <div id="call-panel"></div>
        <div id="call-log"></div> -->
    </div>
    <script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
    <script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
    <script type="text/javascript" src="../components/auth-panel.js"></script>
    <script type="text/javascript" src="../components/dial-pad.js"></script>
    <script type="text/javascript" src="../components/call-panel.js"></script>
    <script type="text/javascript" src="../components/call-log.js"></script>
    <script type="text/javascript">
    var ringCentralAction = {
        login: function(dom) {
            var sdk = new RingCentral.SDK({
                appKey: dom.key.value,
                appSecret: dom.secret.value,
                server: dom.server.value || RingCentral.SDK.server.production
            });
            return sdk.platform()
                .login({
                    username: dom.username.value,
                    extension: dom.extension.value,
                    password: dom.password.value
                })
                .then(() => registerSIP())


            function registerSIP() {
                this.webPhone = new RingCentral.WebPhone({
                    audioHelper: {
                        incoming: '../demo/audio/incoming.ogg',
                        outgoing: '../demo/audio/outgoing.ogg'
                    }
                });
                return sdk.platform()
                    .post('/client-info/sip-provision', {
                        sipInfo: [{
                            transport: 'WSS'
                        }]
                    })
                    .then(res => {
                        var data = res.json();
                        console.log("Sip Provisioning Data from RC API: " + JSON.stringify(data));
                        console.log(data.sipFlags.outboundCallsEnabled);
                        var checkFlags = false;
                        return this.webPhone.register(data, checkFlags)
                            .then(function() {
                                console.log('Registered');
                            })
                            .catch(function(e) {
                                return Promise.reject(err);
                            });

                    }).catch(e => {
                        console.error(e);
                        return Promise.reject(e);
                    });
            }
        },
        signup: function() {}
    }
    var authPanel = new AuthPanel({
        target: '#auth-panel',
        actions: {
            login: function(dom) {
                return ringCentralAction.login(dom);
            },
            signup: function() {}
        },
        listeners: {}
    });

    function switchTheme(theme) {
        document.getElementById('theme-css').href = 'theme/' + theme + '.css';
    }
    </script>
</body>

</html>
