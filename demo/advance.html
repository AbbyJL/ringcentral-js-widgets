<!DOCTYPE html>
<html>

<head>
    <title>RingCentral Web Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../src/styles/normalize.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/main.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/call-log.css">
    <link rel="stylesheet" type="text/css" href="theme/blue.css" id="theme-css">
    <style type="text/css">
    html {
        height: 100%;
    }
    
    body {
        height: 100%;
    }

    #phone {
        width: 250px;
        height: 100%;
        border-right: 1px solid #878787;
        border-left: 1px solid #878787;
        margin: 0 auto;
    }
    </style>
</head>

<body>
    <div id='phone'>
        <div id="auth-panel"></div>
        <div id="toolbar"></div>
        <div id="dial-pad"></div>
        <div id="compose-text"></div>
        <div id="call-panel"></div>
        <div id="call-log"></div>
    </div>
    <script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
    <script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
    <script type="text/javascript" src="../build/build.js"></script>
    <script type="text/javascript">
    w.config({
        path: '../template/',
        preload: {
            'auth-panel': 'auth-panel',
            'dial-pad': 'dial-pad',
            'call-panel': 'call-panel',
            'tool-bar': 'tool-bar',
            'compose-text': 'compose-text',
            'call-log': 'call-log'
        },
        logLevel: 2 /* 0 for error only, 1 for error and warning, 2 for error and warning and log */
    }, init)
    var phoneService = w.service()['phoneService'];
    var loginService = w.service()['loginService'];
    var callLogService = w.service()['callLogService'];
    var accountService = w.service()['accountService'];
    var rcContactService = w.service()['rcContactService'];
    var contactSearchService = w.service()['contactSearchService'];
    var messageService = w.service()['messageService'];
    var rcContactSearchProvider = w.service()['rcContactSearchProvider'];
    
    var dialPadSearchProviders = [rcContactSearchProvider];

    function init() {
        var authPanel = w('auth-panel', {
            actions: {
                login: {
                    method: function() {
                        return loginService.login(
                            this.props.username,
                            this.props.extension,
                            this.props.password
                        );
                    },
                    after: function() {
                        return Promise.all([
                            accountService.getAccountInfo(),
                            accountService.getPhoneNumber(),
                        ])
                        .then(afterLogin)
                        .then(() => {authPanel.hide()})
                        .then(() => {
                            return Promise.all([
                                rcContactService.syncCompanyContact(),
                                phoneService.registerSIP(),
                                callLogService.getCallLogs()
                            ])
                        })
                        .catch(err => console.error(err))
                    }
                }
            }
        })
        
        authPanel.render('#auth-panel');
        // loginService.checkLoginStatus().then(
        //     isLoggedIn => {
        //         authPanel.render('#auth-panel');
        //         if (isLoggedIn) {
        //             authPanel.hide();
        //             return Promise.all([
        //                     accountService.getAccountInfo(),
        //                     accountService.getPhoneNumber(),
        //                     rcContactService.syncCompanyContact(),
        //                     phoneService.registerSIP(),
        //                     callLogService.getCallLogs()
        //                 ])
        //                 .then(afterLogin)
        //                 .catch(err => console.error(err))
        //         }
        //     }
        // );

        function afterLogin() {
            var dialPad = w('dial-pad', {
                actions: {
                    render: {
                        after: function() {
                            if (!accountService.hasServiceFeature("VoipCalling"))
                                this.disable();
                        }
                    },
                    queryContacts: {
                        method: function() {
                            var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                return provider.search(this.props.to);
                            });
                            return contactSearchService.query(dialPadSearchFunctions);
                        }
                    },
                    callout: {
                        method: function(fromNo, toNo) {
                            return phoneService.callout(fromNo, toNo);
                        }
                    },
                    getOutboundCallerID: {
                        method: function() {
                            return accountService.listNumber("VoiceFax");
                        }
                    }
                }
            });
            var callPanel = w('call-panel', {
                actions: {
                    init: {
                        after: function() {
                            phoneService.listen();
                            phoneService.on('called', this.called);
                            phoneService.on('callStarted', this.callStarted);
                            phoneService.on('callRejected', this.callRejected);
                            phoneService.on('callEnded', this.callEnded);
                            phoneService.on('callFailed', this.callFailed);
                        }
                    },
                    answer: {
                        method: function() {
                            phoneService.answer();
                        }
                    },
                    hangup: {
                        method: function() {
                            phoneService.hangup();
                        }
                    }
                }
            })
            var composeText = w('compose-text', {
                actions: {
                    getOutboundCallerID: {
                        method: function() {
                            return accountService.listNumber("VoiceFax");
                        }
                    },
                    queryContacts: {
                        method: function() {
                            var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                return provider.search(this.props.to);
                            });
                            return contactSearchService.query(dialPadSearchFunctions);
                        }
                    },
                    send: {
                        method: function() {
                            return messageService.sendSMSMessage(
                                this.props.text,
                                this.props.fromNumber,
                                this.props.toNumber
                            );
                        }
                    }
                }
            });
            var callLog = w('call-log', {
                actions: {
                    init: {
                        method: function() {
                            return callLogService.getCallLogs();
                        }
                    }
                }
            })
            var toolbar = w('tool-bar', {
                actions: {
                    init: {
                        after: function() {
                            var panels = [dialPad, composeText, callLog]
                            this.clickItem(this.addItem('<img src="../src/styles/images/dialpad_normal.png">'), function() {
                                panels.forEach(panel => panel.hide())
                                dialPad.show();
                            });
                            this.clickItem(this.addItem('<img src="../src/styles/images/sms_normal.png">'), function() {
                                panels.forEach(panel => panel.hide())
                                composeText.show();
                            });
                            this.clickItem(this.addItem('<img src="../src/styles/images/call_log_normal.png">'), function() {
                                panels.forEach(panel => panel.hide())
                                callLog.show();
                            });
                            this.clickItem(
                                this.addItem(
                                    '<img src="../src/styles/images/logout.png">', 
                                    'right'
                                ), logout);
                            // this.addItem('<img src="../src/styles/images/settings_normal.png">');
                        }
                    },
                    render: {
                        after: function() {
                            dialPad.render('#dial-pad');
                            composeText.render('#compose-text');
                            callLog.render('#call-log');

                            composeText.hide();
                            callLog.hide();
                        }
                    }
                }
            })
            callPanel.render('#call-panel');
            toolbar.render('#toolbar');
            function logout() {
                return loginService.logout().then(res => {
                    [dialPad, composeText, callLog, toolbar].forEach(panel => panel.hide())
                    authPanel.show()
                }).catch(err => console.error(err));
            }
        }
    }
    </script>
</body>

</html>
