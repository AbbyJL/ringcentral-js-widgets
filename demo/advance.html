<!DOCTYPE html>
<html>

<head>
    <title>RingCentral Web Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="../build/styles/main.css">
    <style type="text/css">
    html {
        height: 100%;
    }
    
    body {
        height: 100%;
    }

    #phone {
        width: 250px;
        height: 100%;
        border-right: 1px solid #878787;
        border-left: 1px solid #878787;
        overflow: hidden;
        margin: 0 auto;
    }

    .container {
        width: 3000px;
        transition: transform .1s ease-out;
    }
    .panel {
        width: 250px;
    }
    .panel.--extra {
        position: absolute;
    }
    </style>
</head>

<body>
    <div id='phone'>
        <div id="auth-panel"></div>
        <div id="toolbar"></div>
        <div class='container'>
            <div class='panel float-left' id="dial-pad"></div>
            <div class='panel float-left' id="messages-panel"></div>
            <div class='panel float-left' id="contacts"></div>
            <div class='panel float-left' id="call-log"></div>
            <div class='panel float-left' id="conference"></div>
            <div class='panel float-left' id="conversation"></div>
        </div>
        <div class='panel --extra' id="call-panel"></div>
        <div class='panel --extra' id="call-panel-incoming"></div>
    </div>
    <script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
    <script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
    <script type="text/javascript" src="../build/build.js"></script>
    <script type="text/javascript">
    var options = {
        lang: 'en-us'
    };
    w.config({
        path: '../template/',
        preload: {
            'auth-panel': 'auth-panel',
            'dial-pad': 'dial-pad',
            'call-panel': 'call-panel',
            'call-panel-incoming': 'call-panel-incoming',
            'tool-bar': 'tool-bar',
            'conversation': 'conversation',
            'call-log': 'call-log',
            'messages': 'messages',
            'conference': 'conference',
            'contacts': 'contacts'
        },
        locale: {
            'zh-tw': 'zh-tw.json',
            'en-us': 'en-us.json'
        },
        logLevel: 0 /* 0 for error only, 1 for error and warning, 2 for error and warning and log */
    }, init)
    var phoneService = w.service()['phoneService'];
    var loginService = w.service()['loginService'];
    var callLogService = w.service()['callLogService'];
    var accountService = w.service()['accountService'];
    var rcContactService = w.service()['rcContactService'];
    var contactSearchService = w.service()['contactSearchService'];
    var rcContactSearchProvider = w.service()['rcContactSearchProvider'];
    var rcMessageService = w.service()['rcMessageService'];
    var rcMessageProvider = w.service()['rcMessageProvider'];
    var rcConferenceSerivce = w.service()['rcConferenceSerivce'];

    
    var dialPadSearchProviders = [rcContactSearchProvider];

    function init() {
        var authPanel = w('auth-panel', {
            data : { lang: 'en-us' },
            actions: {
                login: {
                    method: function() {
                        return loginService.login(
                            this.props.username,
                            this.props.extension,
                            this.props.password
                        )
                    },
                    after: function() {
                        authPanel.remove()
                        afterLogin();
                    }
                }
            }
        });
        
        function loadData() {
            rcMessageService.subscribeToMessageUpdate();
            rcMessageService.syncMessages();
            accountService.getAccountInfo();
            accountService.getPhoneNumber();
            rcContactService.syncCompanyContact();
            phoneService.registerSIP();
            callLogService.getCallLogs();
            phoneService.listen();
        } 
        
        loginService.checkLoginStatus().then(isLoggedIn => {
            if(isLoggedIn){
                afterLogin();
            }else{
                authPanel.mount('#auth-panel');
            }
        });

        function afterLogin() {
            loadData();
            var conversation;
            var dialPad = w('dial-pad', {
                actions: {
                    mount: {
                        after: function() {
                            if (!accountService.hasServiceFeature("VoipCalling"))
                                this.disable();
                        }
                    },
                    callout: {
                        method: function(fromNo, toNo) {
                            return phoneService.callout(fromNo, toNo);
                        },
                        after: function() {
                            callPanel.mount('#call-panel');
                        }
                    },
                    queryContacts: {
                        method: function() {
                            var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                return provider.search(this.props.to);
                            });
                            return contactSearchService.query(dialPadSearchFunctions);
                        }
                    },
                    getOutboundCallerID: {
                        method: function() {
                            return accountService.listNumber("VoiceFax");
                        }
                    }
                }
            });
            var callPanel = w('call-panel', {
                actions: {
                    init: {
                        method: function() {
                            phoneService.on('callStarted', this.callStarted);
                            phoneService.on('callRejected', this.callRejected);
                            phoneService.on('callEnded', this.callEnded);
                            phoneService.on('callFailed', this.callFailed);
                        }
                    },
                    answer: {
                        method: function() {
                            phoneService.answer();
                        }
                    },
                    hangup: {
                        method: function() {
                            return phoneService.hangup();
                        }
                    }
                }
            })
            var callPanelIncoming = w('call-panel-incoming', {
                actions: {
                    init: {
                        method: function() {
                            console.debug('init')
                            phoneService.on('called', this.called);
                        }
                    },
                    called: {
                        method: function() {
                            console.debug('called');
                            this.mount('#call-panel-incoming');
                        }
                    }
                }
            })
            var callLog = w('call-log', {
                actions: {
                    init: {
                        method: function() {
                            return callLogService.getCallLogs();
                        }
                    }
                }
            });
            var messageWidget = w('messages', {
                data: options,
                actions: {
                    mount: {
                        after: function(){
                            rcMessageProvider.onMessageUpdated(this.refreshMessages);
                        }
                    },
                    refreshMessages: {
                        method: function(){
                            return rcMessageProvider.getLastMessagesOfAllType();
                        }
                    },
                    viewMessageInfo: {
                        method: function(){
                            alert(this.props.selectedMessage.type);
                        }
                    },
                    enterMessage: {
                        before: function() {},
                        method: function() {
                            // TODO: makes the div temp
                            document.querySelector('.container').style.transform = 'translateX(-1250px)';
                            if (conversation)
                                conversation.destroy()
                            conversation = w('conversation', {
                                data: {
                                    new: false,
                                    fromNumber: this.props.selectedMessage.author,
                                    toNumber: this.props.selectedMessage.contact
                                },
                                actions: {
                                    mount: {
                                        after: function() {
                                            rcMessageService.onMessageUpdated(this.confirmMessages);
                                            rcMessageService.onMessageUpdated(this.addIncomingMessages);
                                        }
                                    },
                                    send: {
                                        method: function() {
                                            return rcMessageService.sendSMSMessage(
                                                this.props.message,
                                                this.props.fromNumber,
                                                this.props.toNumber
                                            );
                                        }
                                    },
                                    queryContacts: {
                                        method: function() {
                                            var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                                return provider.search(this.props.to);
                                            });
                                            return contactSearchService.query(dialPadSearchFunctions);
                                        }
                                    },
                                    getOutboundCallerID: {
                                        method: function() {
                                            return accountService.listNumber("VoiceFax");
                                        }
                                    }
                                }
                            });
                            conversation.mount('#conversation');

                            return rcMessageProvider
                            .getConversation(this.props.selectedMessage.convId)
                            .then(conversation.addMessages)
                        }
                    }
                }
            });
            var conference = w('conference',{
                data : options,
                actions: {
                    getConferenceInfo: {
                        method: function() {
                            return rcConferenceSerivce.getConferenceInfo();
                        }
                    },
                    inviteWithText: {
                        method: function() {
                        }
                    }
                }
            });
            var contacts = w('contacts', {
                data : options,
                actions: {
                    fetchContacts: {
                        method: function() {
                            var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                return provider.searchAll();
                            });
                            return contactSearchService.query(dialPadSearchFunctions);
                        }
                    }
                }
            });
            
            
            var toolbar = w('tool-bar', {
                actions: {
                    init: {
                        after: function() {
                            this.clickItem(
                                this.addItem('<span class="icon-uniA4"></span><span class="icon-RC_shapes_1-40_pressed"></span>'), 
                                function() {
                                    document.querySelector('.container').style.transform = 'translateX(0)';
                                    if (conversation) {
                                        conversation.destroy()
                                        conversation = null
                                    }
                                });
                            this.clickItem(
                                this.addItem('<span class="icon-uni2487"></span></span><span class="icon-RC_shapes_1_30_pressed"></span>'),
                                function() {
                                    document.querySelector('.container').style.transform = 'translateX(-250px)';
                                    if (conversation) {
                                        conversation.destroy()
                                        conversation = null
                                    }
                                });
                            this.clickItem(
                                this.addItem('<span class="icon-uni7D"></span><span class="icon-contact_info_pressed"></span>'),
                                 function() {
                                    document.querySelector('.container').style.transform = 'translateX(-500px)';
                                    if (conversation) {
                                        conversation.destroy()
                                        conversation = null
                                    }
                                });
                            this.clickItem(
                                this.addItem('<span class="icon-uniC8"></span><span class="icon-RC_shapes_2-30_pressed"></span>'),
                                function() {
                                    document.querySelector('.container').style.transform = 'translateX(-750px)';
                                    if (conversation) {
                                        conversation.destroy()
                                        conversation = null
                                    }
                                });
                            this.clickItem(
                                this.addItem('<span class="icon-uniA3"></span>', 'Conference'),
                                function() {
                                    document.querySelector('.container').style.transform = 'translateX(-1000px)';
                                    if (conversation) {
                                        conversation.destroy()
                                        conversation = null
                                    }
                                });
                            this.clickItem(
                                this.addItem('<span class="icon-uni47"></span>', 'Meeting'),
                                function() {
                                    document.querySelector('.container').style.transform = 'translateX(-750px)';
                                    if (conversation) {
                                        conversation.destroy()
                                        conversation = null
                                    }
                                });
                            // this.addItem('<img src="../src/styles/images/settings_normal.png">');
                        }
                    },
                    mount: {
                        after: function() {
                            dialPad.mount('#dial-pad');
                            messageWidget.mount('#messages-panel');
                            callLog.mount('#call-log');
                            contacts.mount('#contacts');
                            conference.mount('#conference');
                        }
                    }
                }
            });
            
            toolbar.mount('#toolbar');
            function logout() {
                return loginService.logout().then(res => {
                    [dialPad, conversation, callLog, toolbar].forEach(panel => panel.remove())
                    init()
                }).catch(err => console.error(err));
            }
        }
    }
    </script>
</body>

</html>
