<!DOCTYPE html>
<html>

<head>
    <title>RingCentral Web Phone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../src/styles/normalize.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/main.css">
    <link rel="stylesheet" type="text/css" href="../src/styles/call-log.css">
    <link rel="stylesheet" type="text/css" href="theme/blue.css" id="theme-css">
    <style type="text/css">
    html {
        height: 100%;
    }
    
    body {
        width: 250px;
        height: 100%;
        border-right: 1px solid #878787;
    }
    </style>
</head>

<body>
    <div id='phone'>
        <div id="auth-panel"></div>
        <div id="dial-pad"></div>
        <div id="call-panel"></div>
        <div id="call-log-panel"></div>
    </div>
    <script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
    <script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
    <script type="text/javascript" src="../build/build.js"></script>
    <script type="text/javascript">
    w.config({
        path: '../template/',
        preload: {
            'auth-panel': 'auth-panel',
            'dial-pad': 'dial-pad',
            'call-panel': 'call-panel'
        }
    }, init)
    var phoneService = w.service()['phoneService'];
    var loginService = w.service()['loginService'];
    var callLogService = w.service()['callLogService'];

    function init() {
        var authPanel = w('auth-panel', {
            actions: {
                login: {
                    method: function() {
                        return loginService.login(
                            this.props.username,
                            this.props.extension,
                            this.props.password
                        ).then(() => {
                            return new Promise((resolve, reject) => {
                                FB.getLoginStatus(function(response) {
                                    if (response.status === 'connected') {
                                        resolve();
                                    } else {
                                        FB.login(function(response) {
                                            if (response.status === 'connected') {
                                                resolve();
                                            } else if (response.status === 'not_authorized') {
                                                reject('facebook login fails');
                                            } else {
                                                reject('facebook login fails');
                                            }
                                        }, {
                                            scope: 'email'
                                        });
                                    }
                                });
                            })

                        });
                    },
                    after: function() {
                        var authPanel = this;
                        dialPad.render('#dial-pad', function() {
                            authPanel.remove();
                        });
                        callPanel.render('#call-panel');
                    }
                }
            },
            handlers: {},
        })
        var dialPad = w('dial-pad', {
            actions: {
                getCandidates: {
                    method: function() {
                        return CallLogService.getCallLogs();
                    }
                },
                callout: {
                    method: function(fromNo, toNo) {
                        return phoneService.callout(fromNo, toNo);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                }
            }
        })
        var callPanel = w('call-panel', {
            actions: {
                init: {
                    after: function() {
                        phoneService.listen();
                        phoneService.on('called', this.called);
                        phoneService.on('callStarted', this.callStarted);
                        phoneService.on('callRejected', this.callRejected);
                        phoneService.on('callEnded', this.callEnded);
                        phoneService.on('callFailed', this.callFailed);
                    }
                },
                answer: {
                    method: function() {
                        phoneService.answer();
                    }
                },
                hangup: {
                    method: function() {
                        phoneService.hangup();
                        FB.ui({
                            method: 'send',
                            link: 'http://www.ringcentral.com/',
                        });
                    },
                }
            }
        })
        authPanel.render('#auth-panel');
        // LoginService.checkLoginStatus().then(
        //     isLoggedIn => {
        //         if (isLoggedIn) {
        //             dialPad.render('#dial-pad');
        //             callPanel.render('#call-panel');
        //         } else
        //             authPanel.render('#auth-panel');
        //     }
        // );
    }
    loginService.registerLoginHandler(function() {
        phoneService.registerSIP();
        callLogService.getCallLogs();
    });
    </script>
    <script>
    window.fbAsyncInit = function() {
        FB.init({
            appId: '1727200887517400',
            xfbml: true,
            version: 'v2.5'
        });
    };

    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>
</body>

</html>
