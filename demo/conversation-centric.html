<!DOCTYPE html>
<html>
<head>
    <title>Conversation</title>
    <link rel="stylesheet" type="text/css" href="../build/styles/main.css">
</head>
<div id='container'></div>
<body>
<script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
<script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
<script type="text/javascript" src="../build/build.js"></script>
<script>
w.config({
    path: '../template/',
    preload: {
        'conversation': 'conversation-advanced',
        'auth-panel': 'auth-panel'
    },
    locale: {
        'zh-tw': 'zh-tw.json',
        'en-us': 'en-us.json'
    }
}, init)
var rcMessageService = w.service()['rcMessageService']
var rcMessageProvider = w.service()['rcMessageProvider']
var accountService = w.service()['accountService']
var loginService = w.service()['loginService']
var rcContactSearchProvider = w.service()['rcContactSearchProvider']
var rcContactService = w.service()['rcContactService']
var callLogService = w.service()['callLogService']
var conversationService = w.service()['conversationService']
var dialPadSearchProviders = [rcContactSearchProvider]

function init() {
    var authPanel = w('auth-panel', {
        actions: {
            login: {
                method: function() {
                    return loginService.login(
                        this.props.username,
                        this.props.extension,
                        this.props.password
                    )
                },
                after: function() {
                    this.unmount()
                    conversation.mount('#container')
                }
            }
        }
    })
    var conversation = w('conversation', {
        data: {
            new: true
        },
        actions: {
            init: {
                after: function() {
                    this.props.hourOffset = 3 * 24
                }
            },
            mount: {
                method: function() {
                    // test with mocked data----------------------------
                    // rcMessageService.syncMessages = () => {
                    //     return fetch('./message').then(res => res.json())
                    // }
                    rcContactService.completeCompanyContact = () => {
                        return fetch('./contact').then(res => res.json())
                    }
                    // callLogService.getCallLogs = () => {
                    //     return fetch('./calllog').then(res => res.json())
                    // }
                    //---------------------------------------------------
                    accountService.getAccountInfo()
                    .then(info => this.props.fromExtension = info.extensionNumber)
                    .then(this.getOutboundCallerID)

                    rcMessageService.subscribeToMessageUpdate()
                    rcMessageService.onMessageUpdated(msgs => this.confirmMessages(msgs.map(adaptMessage)))
                    rcMessageService.onMessageUpdated(msgs => this.addIncomingMessages(msgs.map(adaptMessage)))
                    return Promise.all([
                        rcMessageService.syncMessages(conversationService.cachedHour),
                        callLogService.getCallLogs(),
                        rcContactService.completeCompanyContact()
                    ]).then(result => {
                        var [msgs, logs, contacts] = result
                        return conversationService.getConversations(contacts, msgs, logs)
                    })
                    //
                }
            },
            send: {
                method: function() {
                    if (this.props.toNumber === this.props.toExtension) {
                        return rcMessageService.sendPagerMessage(
                            this.props.message,
                            this.props.fromExtension,
                            this.props.toExtension
                        );
                    }
                    else {
                        return rcMessageService.sendSMSMessage(
                            this.props.message,
                            this.props.fromNumber,
                            this.props.toNumber
                        );
                    }
                }
            },
            queryContacts: {
                method: function() {
                    var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                        return provider.search(this.props.to);
                    });
                    return contactSearchService.query(dialPadSearchFunctions);
                }
            },
            getOutboundCallerID: {
                method: function() {
                    return accountService.getPhoneNumber().then(() => 
                        accountService.listNumber("VoiceFax", 'SmsSender'));
                }
            },
            reachTop: {
                method: function() {
                    return conversationService.syncContent(this.props.contact, this.props.hourOffset)
                }
            }
        }
    });
    authPanel.mount('#container')
}
</script>
</body>
</html>
