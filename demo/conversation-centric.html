<!DOCTYPE html>
<html>
<head>
    <title>Conversation</title>
    <link rel="stylesheet" type="text/css" href="../build/styles/main.css">
</head>
<div id='container'></div>
<body>
<script type="text/javascript" src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
<script type="text/javascript" src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
<script type="text/javascript" src="../build/build.js"></script>
<script>
w.config({
    path: '../template/',
    preload: {
        'messages': 'messages',
        'conversation': 'conversation-advanced',
        'contacts': 'contacts',
        'auth-panel': 'auth-panel',
    },
    locale: {
        'zh-tw': 'zh-tw.json',
        'en-us': 'en-us.json'
    }
}, init)
var rcMessageService = w.service()['rcMessageService']
var rcMessageProvider = w.service()['rcMessageProvider']
var accountService = w.service()['accountService']
var loginService = w.service()['loginService']
var rcContactSearchProvider = w.service()['rcContactSearchProvider']
var rcContactService = w.service()['rcContactService']
var callLogService = w.service()['callLogService']
var conversationService = w.service()['conversationService']
var dialPadSearchProviders = [rcContactSearchProvider]

function init() {
    var authPanel = w('auth-panel', {
        actions: {
            login: {
                method: function() {
                    return loginService.login(
                        this.props.username,
                        this.props.extension,
                        this.props.password
                    )
                },
                after: function() {
                    this.unmount()
                    // conversation.mount('#container')
                    // messageWidget.mount('#container')
                    contacts.mount('#container')
                }
            }
        }
    })

    var contacts = w('contacts', {
        actions: {
            init: {
                after: function() {
                    rcContactService.completeCompanyContact = () => {
                        return fetch('./contact').then(res => res.json())
                    }
                }
            },
            mount: {
                after: function() {
                    
                }
            },
            fetchRelatedContact: {
                method: function() {
                    return Promise.all([
                        rcMessageService.syncMessages(conversationService.cachedHour),
                        callLogService.getCallLogs(),
                        rcContactService.completeCompanyContact()
                    ]).then(result => {
                        var [msgs, logs, contacts] = result
                        return conversationService.getConversations(contacts, msgs, logs)
                    }).then(relateContacts => {
                        this.props.relateContacts = relateContacts
                        return relateContacts
                    }).then(relateContacts => 
                        Object.keys(relateContacts).map(index => {
                            console.log(relateContacts);
                            // adapt to messages template format
                            relateContacts[index].msg[0].contact = relateContacts[index].displayName
                            // for conversation-advance temaplate
                            relateContacts[index].msg[0].contactId = index
                            return relateContacts[index].msg[0]
                        })
                    )
                }
            },
            fetchContacts: {
                method: function() {
                    var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                        return provider.searchAll();
                    });
                    return contactSearchService.query(dialPadSearchFunctions);
                }
            },
            selectContact: {
                method: function() {
                    this.unmount()
                    var contact = this.props.relateContacts[this.props.selectedContact.id]
                    var conversation = conv(contact)
                    conversation.mount('#container')
                }
            }
        }
    });
    var messageWidget = w('messages', {
        actions: {
            mount: {
                after: function(){
                    rcMessageService.subscribeToMessageUpdate()
                    rcMessageProvider.onMessageUpdated(this.refreshMessages)
                }
            },
            refreshMessages: {
                method: function(){
                    // test with mocked data----------------------------
                    // rcMessageService.syncMessages = () => {
                    //     return fetch('./message').then(res => res.json())
                    // }
                    rcContactService.completeCompanyContact = () => {
                        return fetch('./contact').then(res => res.json())
                    }
                    // callLogService.getCallLogs = () => {
                    //     return fetch('./calllog').then(res => res.json())
                    // }
                    //---------------------------------------------------
                    
                    return Promise.all([
                        rcMessageService.syncMessages(conversationService.cachedHour),
                        callLogService.getCallLogs(),
                        rcContactService.completeCompanyContact()
                    ]).then(result => {
                        var [msgs, logs, contacts] = result
                        return conversationService.getConversations(contacts, msgs, logs)
                    }).then(relateContacts => {
                        this.props.relateContacts = relateContacts
                        return relateContacts
                    })
                    .then(relateContacts => 
                        Object.keys(relateContacts).map(index => {
                            console.log(relateContacts);
                            // adapt to messages template format
                            relateContacts[index].msg[0].contact = relateContacts[index].displayName
                            // for conversation-advance temaplate
                            relateContacts[index].msg[0].contactId = index
                            return relateContacts[index].msg[0]
                        })
                    )
                }
            },
            enterMessage: {
                before: function() {},
                method: function() {
                    // TODO: makes the div temp
                    this.unmount()
                    var contact = this.props.relateContacts[this.props.selectedMessage.contactId]
                    var conversation = conv(contact)
                    conversation.mount('#container')
                }
            },
            compose: {
                method: function() {
                   
                },
                after: function() {

                }
            }
        }
    });
    
    authPanel.mount('#container')
}

function conv(contact) {
    return w('conversation', {
        data: {
            new: true,
            contact: contact
        },
        actions: {
            init: {
                after: function() {
                    this.props.hourOffset = 3 * 24
                }
            },
            mount: {
                after: function() {
                    conversationService.onConversationUpdate(this.confirmMessages)
                    conversationService.onConversationUpdate(this.addIncomingMessages)
                    return accountService.getAccountInfo()
                            .then(info => this.props.fromExtension = info.extensionNumber)
                            .then(this.getOutboundCallerID)
                }
            },
            send: {
                method: function() {
                    if (this.props.toNumber === this.props.toExtension) {
                        return rcMessageService.sendPagerMessage(
                            this.props.message,
                            this.props.fromExtension,
                            this.props.toExtension
                        );
                    }
                    else {
                        return rcMessageService.sendSMSMessage(
                            this.props.message,
                            this.props.fromNumber,
                            this.props.toNumber
                        );
                    }
                }
            },
            queryContacts: {
                method: function() {
                    var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                        return provider.search(this.props.to);
                    });
                    return contactSearchService.query(dialPadSearchFunctions);
                }
            },
            getOutboundCallerID: {
                method: function() {
                    return accountService.getPhoneNumber().then(() => 
                        accountService.listNumber("VoiceFax", 'SmsSender'));
                }
            },
            reachTop: {
                method: function() {
                    return conversationService.syncContent(this.props.contact, this.props.hourOffset)
                }
            }
        }
    });
    conversation.mount('#container')
}
</script>
</body>
</html>
