<style>
    .rc-phone {
        position: relative;
        width: 250px;
        height: 100%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        overflow: hidden;
        margin: 0 auto;
    }

    .rc-phone > .container {
        width: 3000px;
        transition: transform .1s ease-out;
    }
    .rc-phone .panel {
        width: 250px;
        min-height: 1px;
    }
    .rc-phone .panel.--extra {
        position: absolute;
        left: 0;
    }
</style>
<div>
    <div id='phone' class='rc-phone'>
        <div id="auth-panel"></div>
        <div id="toolbar"></div>
        <div class='container' data-info='container'>
            <div class='panel float-left' id="dial-pad"></div>
            <div class='panel float-left' id="messages-panel"></div>
            <div class='panel float-left' id="contacts"></div>
            <div class='panel float-left' id="call-log"></div>
            <div class='panel float-left' id="conference"></div>
        </div>
        <div class='panel --extra' id="call-panel"></div>
        <div class='panel --extra' id="call-panel-incoming"></div>
        <div class='panel --extra' id="conversation"></div>
        <div class='panel --extra' id="contact-detail"></div>
        <div class='panel --extra' id="notification"></div>
    </div>
</div>
<script src='../bower_components/phoneformat/dist/phone-format-global.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js'></script>
<script>
var phone = w.register(function() {
    this.actions = {
        getService: {
            method: function() {
                return {
                    phoneService: w.service()['phoneService'],
                    loginService: w.service()['loginService'],
                    callLogService: w.service()['callLogService'],
                    accountService: w.service()['accountService'],
                    rcContactService: w.service()['rcContactService'],
                    contactSearchService: w.service()['contactSearchService'],
                    rcContactSearchProvider: w.service()['rcContactSearchProvider'],
                    rcMessageService: w.service()['rcMessageService'],
                    rcMessageProvider: w.service()['rcMessageProvider'],
                    rcConferenceSerivce: w.service()['rcConferenceSerivce'],
                    contactDetailWidgetAdapter: w.service()['contactDetailWidgetAdapter'],
                    dialPadSearchProviders: [rcContactSearchProvider]
                }
            }
        },
        loadData: {
            method: function() {
                this.getService().rcMessageService.subscribeToMessageUpdate();
                this.getService().rcMessageService.syncMessages(this.props.cachedMessageHours);
                this.getService().accountService.getAccountInfo();
                this.getService().accountService.getPhoneNumber();
                // this.getService().rcContactService.syncCompanyContact();
                // this.getService().phoneService.registerSIP();
                this.getService().callLogService.getCallLogs();
                this.getService().phoneService.listen();
            }
        },
        createWidgets: {
            method: function() {
                var {
                    phoneService,
                    loginService,
                    callLogService,
                    accountService,
                    rcContactService,
                    contactSearchService,
                    rcContactSearchProvider,
                    rcMessageService,
                    rcMessageProvider,
                    rcConferenceSerivce,
                    contactDetailWidgetAdapter,
                    dialPadSearchProviders
                } = this.getService()
                var phone = this
                this.props.conversation = undefined;
                this.props.contactDetail = undefined;
                this.props.dialPad = w('dial-pad', {
                    shadowRoot: phone.data.shadowRoot,
                    data : phone.data,
                    actions: {
                        mount: {
                            after: function() {
                                if (!accountService.hasServiceFeature("VoipCalling"))
                                    this.disable();
                            }
                        },
                        callout: {
                            method: function() {
                                return phoneService.callout(this.props.fromNumber, this.props.toNumber);
                            },
                            after: function() {
                                phone.props.callPanel.mount('#call-panel');
                            },
                            error: function(e) {
                                console.error(e);
                                phone.props.notification.show('#notification', 4000)
                                phone.props.notification.msg(e.message)
                            }
                        },
                        queryContacts: {
                            method: function() {
                                var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                    return provider.search(this.props.toNumber);
                                });
                                return contactSearchService.query(dialPadSearchFunctions);
                            }
                        },
                        getOutboundCallerID: {
                            method: function() {
                                return accountService.listNumber("VoiceFax", 'CallerId');
                            }
                        }
                    }
                });
                this.props.callPanel = w('call-panel', {
                    shadowRoot: phone.data.shadowRoot,
                    data : phone.data,
                    actions: {
                        init: {
                            method: function() {
                                phoneService.on('callStarted', this.callStarted);
                                phoneService.on('callRejected', this.callRejected);
                                phoneService.on('callEnded', this.callEnded);
                                phoneService.on('callFailed', this.callFailed);
                            }
                        },
                        answer: {
                            method: function() {
                                phoneService.answer();
                            }
                        },
                        hangup: {
                            method: function() {
                                return phoneService.hangup();
                            }
                        }
                    }
                })
                this.props.callPanelIncoming = w('call-panel-incoming', {
                    shadowRoot: phone.data.shadowRoot,
                    data : phone.data,
                    actions: {
                        init: {
                            method: function() {
                                console.log(this);
                                phoneService.on('called', this.called);
                            }
                        },
                        called: {
                            method: function() {
                                this.mount('#call-panel-incoming');
                            }
                        }
                    }
                })
                this.props.callLog = w('call-log', {
                    shadowRoot: phone.data.shadowRoot,
                    actions: {
                        init: {
                            method: function() {
                                return callLogService.getCallLogs();
                            }
                        }
                    }
                });
                this.props.timeline = w('time-line', {
                    shadowRoot: phone.data.shadowRoot,
                    actions: {
                        mount: {
                            after: function() {
                                rcMessageService.subscribeToMessageUpdate()
                                rcMessageProvider.onMessageUpdated(msg => {
                                    this.updateTimeline(conversationService.syncContent(this.props.contacts, msg))
                                    if (this.props.currentConv) {
                                        this.props.currentConv.confirmMessages()
                                        this.props.currentConv.addIncomingMessages()
                                    }
                                })
                                return rcContactService.cacheContacts().then(contacts => this.props.contacts = contacts)
                            }
                        },
                        fetchData: {
                            method: function() {
                                return Promise.all([
                                    rcContactService.cacheContacts(), // first one must be the contacts
                                    rcMessageService.syncMessages(conversationService.cachedHour),
                                    callLogService.getCallLogs(),
                                ]).then(result => conversationService.organizeContent(...result))
                            }
                        },
                        search: {
                            method: function() {
                                contacts.dom.searchText.value = this.dom.searchText.value 
                                contacts.search()
                            }
                        },
                        enterItem: {
                            after: function() {
                                // this.unmount()
                                var contact = this.props.selectedContent.contact
                                var fromNumber = contact.msg[0].direction === 'Outbound'? contact.msg[0].from: contact.msg[0].to
                                var toNumber = contact.msg[0].direction === 'Outbound'? contact.msg[0].to: contact.msg[0].from
                                this.props.currentConv = conv(contact, () => {
                                    this.props.currentConv.unmount()
                                }, {
                                    fromNumber,
                                    toNumber,
                                    anchorContent: this.props.selectedContent
                                })
                                this.props.currentConv.mount('#conversation')
                            }
                        }
                    }
                })
                this.props.conference = w('conference',{
                    data : phone.data,
                    actions: {
                        getConferenceInfo: {
                            method: function() {
                                return rcConferenceSerivce.getConferenceInfo();
                            }
                        },
                        inviteWithText: {
                            method: function() {
                                
                            }
                        },
                        joinAsHost: {
                            method: function() {
                                phone.dom.container.style.transform = 'translateX(0px)';
                                phone.props.dialPad.mount('#dial-pad');
                                phone.props.dialPad.setNumber(phone.props.conference.props.dialInNumber)
                            }
                        }
                    }
                });
                this.props.contacts = w('contacts', {
                    shadowRoot: phone.data.shadowRoot,
                    data: {},
                    actions: {
                        init: {
                            after: function() {}
                        },
                        mount: {
                            after: function() {
                                this.fetchContacts()
                            }
                        },
                        fetchRelatedContact: {
                            method: function() {
                                return Promise.all([
                                    rcMessageService.syncMessages(conversationService.cachedHour),
                                    callLogService.getCallLogs(),
                                    rcContactService.cacheContacts()
                                ]).then(result => {
                                    var [msgs, logs, contacts] = result
                                    this.props.contacts = contacts.reduce((result, contact) => {
                                        result[contact.id] = contact
                                        return result
                                    }, {})
                                    return conversationService.getConversations(contacts, msgs, logs)
                                }).then(relateContacts => {
                                    this.props.relateContacts = relateContacts
                                    return relateContacts
                                }).then(relateContacts => 
                                    Object.keys(relateContacts).map(index => {
                                        // adapt to messages template format
                                        relateContacts[index].msg[0].contact = relateContacts[index].displayName
                                        // for conversation-advance temaplate
                                        relateContacts[index].msg[0].contactId = index
                                        return relateContacts[index].msg[0]
                                    })
                                )
                            }
                        },
                        fetchContacts: {
                            method: function() {
                                // var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                //     return provider.searchAll();
                                // });
                                // return contactSearchService.query(dialPadSearchFunctions);
                                return rcContactService.cacheContacts().then(contacts => {
                                    this.props.contacts = contacts.reduce((result, contact) => {
                                        result[contact.id] = contact
                                        return result
                                    }, {})
                                    return contacts.map(contact => {
                                        return {
                                            name: contact.displayName,
                                            type: 'rc',
                                            id: contact.id,
                                        }
                                    });
                                }).catch(e => console.error(e))
                            }
                        },
                        selectContact: {
                            method: function() {
                                var contact = 
                                    (this.props.relateContacts && 
                                    this.props.relateContacts[this.props.selectedContact.id]) ||
                                    this.props.contacts[this.props.selectedContact.id]
                                var conversation = phone.props.timeline.props.currentConv = conv(contact, () => {
                                    phone.props.timeline.mount('#contact-detail')
                                })
                                conversation.mount('#contact-detail')
                            }
                        },
                        focus: {
                            after: function() {
                                console.log('focus');
                            }
                        }
                    }
                });
                this.props.toolbar = w('tool-bar', {
                    shadowRoot: phone.data.shadowRoot,
                    data : phone.data,
                    actions: {
                        init: {
                            after: function() {
                                this.clickItem(
                                    this.addItem('<span class="icon-uniA4"></span><span class="icon-RC_shapes_1-40_pressed"></span>'), 
                                        phone.switchWidgets(
                                            phone.props.dialPad,
                                            '#dial-pad', 0
                                        ).fn
                                    )
                                this.clickItem(
                                    this.addItem('<span class="icon-uni2487"></span></span><span class="icon-RC_shapes_1_30_pressed"></span>'), 
                                        phone.switchWidgets(
                                            phone.props.timeline,
                                            '#messages-panel', 1
                                        ).fn
                                    )
                                this.clickItem(
                                    this.addItem('<span class="icon-uni7D"></span><span class="icon-contact_info_pressed"></span>'), 
                                        phone.switchWidgets(
                                            phone.props.contacts,
                                            '#contacts', 2
                                        ).fn
                                    )
                                this.clickItem(
                                    this.addItem('<span class="icon-uniC8"></span><span class="icon-RC_shapes_2-30_pressed"></span>'), 
                                        phone.switchWidgets(
                                            phone.props.callLog,
                                            '#call-log', 3
                                        ).fn
                                    )
                                this.clickItem(
                                    this.addItem('<span class="icon-uniA3"></span>', 'Conference'), 
                                        phone.switchWidgets(
                                            phone.props.conference,
                                            '#conference', 4
                                        ).fn
                                    )
                                this.clickItem(
                                    this.addItem('<span class="icon-uni47"></span>', 'Meeting'),
                                    function() {
                                        phone.dom.container.style.transform = 'translateX(-750px)';
                                        if (phone.props.conversation) {
                                            phone.props.conversation.destroy()
                                            phone.props.conversation = null
                                        }
                                    });
                                // this.addItem('<img src="../src/styles/images/settings_normal.png">');
                            }
                        },
                        mount: {
                            after: function() {
                                phone.props.dialPad.mount('#dial-pad');
                            }
                        }
                    }
                });
                this.props.authPanel = w('auth-panel', {
                    shadowRoot: phone.data.shadowRoot,
                    data : phone.data,
                    actions: {
                        login: {
                            method: function() {
                                return loginService.login(
                                    PhoneFormat.formatE164('US', this.props.username),
                                    this.props.extension,
                                    this.props.password
                                )
                            },
                            after: function() {
                                this.unmount()
                                phone.loadData();
                                if (phone.data.shadowRoot)
                                    phone.props.toolbar.mount(phone.data.shadowRoot.querySelector('#toolbar'))
                                else
                                    phone.props.toolbar.mount('#toolbar');
                            }
                        }
                    }
                });
                this.props.notification = w('notification', {})
                this.props.panels = [
                    this.props.dialPad,
                    this.props.callPanel,
                    this.props.callPanelIncoming,
                    this.props.callLog,
                    this.props.timeline,
                    this.props.conference,
                    this.props.contacts,
                    this.props.toolbar,
                    this.props.authPanel
                ]
            }
        },
        switchWidgets: {
            method: function(finish, source, target, index) {
                return {
                    fn: () => {
                        if (this.props.conversation) {
                            this.props.conversation.destroy()
                            this.props.conversation = null
                        }
                        if(this.props.contactDetail){
                            this.props.contactDetail.destroy();
                            this.props.contactDetail = null;
                        }
                        this.dom.container.style.transform = `translateX(${0 - index * 250}px)`;
                        this.dom.container.removeEventListener('transitionend', h)
                        this.dom.container.addEventListener('transitionend', h)
                        source.mount(target);
                        var h = e => {
                            this.props.panels.filter((p, idx) => idx !== index).forEach(p => p.unmount())
                            this.removeEventListener('transitionend', h)
                        }
                    }
                }
            }
        },
        init: {
            after: function() {
                this.props.cachedMessageHours = 7 * 24
            }
        },
        mount: {
            after: function() {
                this.createWidgets()
                this.getService().loginService.checkLoginStatus().then(isLoggedIn => {
                    if (this.data.shadowRoot)
                        this.props.authPanel.mount(this.data.shadowRoot.querySelector('#auth-panel'))
                    else
                        this.props.authPanel.mount('#auth-panel')
                }).catch(err => console.error(err))
                // this.props.authPanel.mount('#auth-panel');
            }
        }
    }
})


function conv(contact, afterBack, options = {}) {
    return w('conversation-advanced', {
        data: {
            new: true,
            contact: contact,
            fromNumber: options.fromNumber,
            toNumber: options.toNumber,
            anchorContent: options.anchorContent
        },
        actions: {
            init: {
                after: function() {
                    this.props.hourOffset = 3 * 24
                    
                }
            },
            mount: {
                after: function() {
                    return accountService.getAccountInfo()
                            .then(info => this.props.fromExtension = info.extensionNumber)
                            .then(this.getOutboundCallerID)
                }
            },
            send: {
                method: function() {
                    if (this.props.toNumber === this.props.toExtension) {
                        return rcMessageService.sendPagerMessage(
                            this.props.message,
                            this.props.fromExtension,
                            this.props.toExtension
                        );
                    }
                    else {
                        return rcMessageService.sendSMSMessage(
                            this.props.message,
                            this.props.fromNumber,
                            this.props.toNumber
                        );
                    }
                }
            },
            queryContacts: {
                method: function() {
                    var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                        return provider.search(this.props.to);
                    });
                    return contactSearchService.query(dialPadSearchFunctions);
                }
            },
            getOutboundCallerID: {
                method: function() {
                    return accountService.getPhoneNumber().then(() => 
                        accountService.listNumber("VoiceFax", 'SmsSender'));
                }
            },
            reachTop: {
                method: function() {
                    return conversationService.loadContent(this.props.contact, this.props.hourOffset)
                }
            },
            back: {
                after: function() {
                    this.unmount()
                    if (afterBack && typeof afterBack === 'function')
                        afterBack()
                }
            }
        }
    });
}


//# sourceURL=rc-phone.html
</script>
