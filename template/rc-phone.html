<style>
#phone {
    width: 250px;
    height: 100%;
    border-right: 1px solid #878787;
    border-left: 1px solid #878787;
    overflow: hidden;
    margin: 0 auto;
}
.phone-container {
    width: 3000px;
    transition: transform .1s ease-out;
}
.phone-panel {
    float: left;
    width: 250px;
}
</style>
<div class='phone-container'>
    <div class='phone-panel' id="auth-panel"></div>
    <div class='phone-panel' id="toolbar"></div>
    <div class='phone-panel' id="dial-pad"></div>
    <div class='phone-panel' id="compose-text"></div>
    <div class='phone-panel' id="call-panel"></div>
    <div class='phone-panel' id="call-log"></div>
    <div class='phone-panel' id="messages"></div>
    <auth-panel dynamic></auth-panel>
    <tool-bar dynamic></tool-bar>
    <dial-pad dynamic></dial-pad>
    <compose-text dynamic></compose-text>
    <call-panel dynamic></call-panel>
    <call-log dynamic></call-log-panel>
    <messages dynamic></messages>
</div>
<script>
w.register(function() {
    this.actions = {
        mount: {
            after: function() {
                var phoneService = w.service()['phoneService'];
                var loginService = w.service()['loginService'];
                var callLogService = w.service()['callLogService'];
                var accountService = w.service()['accountService'];
                var rcContactService = w.service()['rcContactService'];
                var contactSearchService = w.service()['contactSearchService'];
                var messageService = w.service()['messageService'];
                var rcContactSearchProvider = w.service()['rcContactSearchProvider'];
                var rcMessageService = w.service()['rcMessageService'];
                var rcMessageProvider = w.service()['rcMessageProvider'];
                
                var dialPadSearchProviders = [rcContactSearchProvider];
                init.call(this)
                function init() {
                    var authPanel = w('auth-panel', {
                        data : this.data,
                        actions: {
                            login: {
                                method: function() {
                                    return loginService.login(
                                        this.props.username,
                                        this.props.extension,
                                        this.props.password
                                    ).then(()=>{
                                        Promise.all([
                                            rcMessageService.subscribeToMessageUpdate(),
                                            rcMessageService.syncMessages()
                                        ]).catch(err => console.error(err));
                                    })
                                },
                                after: function() {
                                    authPanel.remove()
                                    return Promise.all([
                                        accountService.getAccountInfo(),
                                        accountService.getPhoneNumber(),
                                    ])
                                    .then(afterLogin)
                                    .then(() => {
                                        return Promise.all([
                                            rcContactService.syncCompanyContact(),
                                            phoneService.registerSIP(),
                                            callLogService.getCallLogs(),
                                            
                                        ])
                                    })
                                    .catch(err => console.error(err))
                                }
                            }
                        }
                    })
                    
                    authPanel.mount('#auth-panel');
                    // loginService.checkLoginStatus().then(
                    //     isLoggedIn => {
                    //         authPanel.mount('#auth-panel');
                    //         if (isLoggedIn) {
                    //             authPanel.hide();
                    //             return Promise.all([
                    //                     accountService.getAccountInfo(),
                    //                     accountService.getPhoneNumber(),
                    //                     rcContactService.syncCompanyContact(),
                    //                     phoneService.registerSIP(),
                    //                     callLogService.getCallLogs()
                    //                 ])
                    //                 .then(afterLogin)
                    //                 .catch(err => console.error(err))
                    //         }
                    //     }
                    // );

                    function afterLogin() {
                        var dialPad = w('dial-pad', {
                            actions: {
                                mount: {
                                    after: function() {
                                        if (!accountService.hasServiceFeature("VoipCalling"))
                                            this.disable();
                                    }
                                },
                                queryContacts: {
                                    method: function() {
                                        var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                            return provider.search(this.props.to);
                                        });
                                        return contactSearchService.query(dialPadSearchFunctions);
                                    }
                                },
                                callout: {
                                    method: function(fromNo, toNo) {
                                        return phoneService.callout(fromNo, toNo);
                                    }
                                },
                                getOutboundCallerID: {
                                    method: function() {
                                        return accountService.listNumber("VoiceFax");
                                    }
                                }
                            }
                        });
                        var callPanel = w('call-panel', {
                            actions: {
                                init: {
                                    after: function() {
                                        phoneService.listen();
                                        phoneService.on('called', this.called);
                                        phoneService.on('callStarted', this.callStarted);
                                        phoneService.on('callRejected', this.callRejected);
                                        phoneService.on('callEnded', this.callEnded);
                                        phoneService.on('callFailed', this.callFailed);
                                    }
                                },
                                answer: {
                                    method: function() {
                                        phoneService.answer();
                                    }
                                },
                                hangup: {
                                    method: function() {
                                        phoneService.hangup();
                                    }
                                }
                            }
                        })
                        var composeText = w('compose-text', {
                            actions: {
                                getOutboundCallerID: {
                                    method: function() {
                                        return accountService.listNumber("VoiceFax");
                                    }
                                },
                                queryContacts: {
                                    method: function() {
                                        var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                                            return provider.search(this.props.to);
                                        });
                                        return contactSearchService.query(dialPadSearchFunctions);
                                    }
                                },
                                send: {
                                    method: function() {
                                        return messageService.sendSMSMessage(
                                            this.props.text,
                                            this.props.fromNumber,
                                            this.props.toNumber
                                        );
                                    }
                                }
                            }
                        });
                        var callLog = w('call-log', {
                            actions: {
                                init: {
                                    method: function() {
                                        return callLogService.getCallLogs();
                                    }
                                }
                            }
                        });
                        var messageWidget = w('messages', {
                            data: options,
                            actions: {
                                mount: {
                                    after: function(){
                                        rcMessageProvider.onMessageUpdated(() => {
                                            this.refreshMessages();
                                        });
                                    }
                                },
                                refreshMessages: {
                                    method: function(){
                                        return rcMessageProvider.getLastMessagesOfAllType();
                                    }
                                }
                            }
                        });
                        
                        var toolbar = w('tool-bar', {
                            actions: {
                                init: {
                                    after: function() {
                                        var panels = [dialPad, composeText, callLog]
                                        var pos = 0;
                                        this.clickItem(this.addItem('<img src="../src/styles/images/dialpad_normal.png">'), function() {
                                                pos = 0;
                                                document.querySelector('.container').style.transform = 'translateX(0)';
                                        });
                                        this.clickItem(this.addItem('<img src="../src/styles/images/sms_normal.png">'),
                                         function() {
                                            pos = -250;
                                            document.querySelector('.container').style.transform = 'translateX(-250px)';
                                        });
                                        this.clickItem(this.addItem('<img src="../src/styles/images/message_normal.png">'),
                                         function() {
                                            pos = -500;
                                            document.querySelector('.container').style.transform = 'translateX(-500px)';
                                        });
                                        this.clickItem(this.addItem('<img src="../src/styles/images/call_log_normal.png">'), function() {
                                            pos = -750;
                                            document.querySelector('.container').style.transform = 'translateX(-750px)';
                                        });
                                        this.clickItem(
                                            this.addItem(
                                                '<img src="../src/styles/images/logout.png">', 
                                                'right'
                                            ), logout);
                                        // this.addItem('<img src="../src/styles/images/settings_normal.png">');
                                    }
                                },
                                mount: {
                                    after: function() {
                                        dialPad.mount('#dial-pad');
                                        composeText.mount('#compose-text');
                                        callLog.mount('#call-log');
                                        messageWidget.mount('#messages-panel')
                                    }
                                }
                            }
                        });
                        
                        callPanel.mount('#call-panel');
                        toolbar.mount('#toolbar');
                        function logout() {
                            return loginService.logout().then(res => {
                                [
                                    dialPad, 
                                    composeText, 
                                    callLog, 
                                    toolbar, 
                                    messageWidget
                                ].forEach(panel => panel.remove())
                                init()
                            }).catch(err => console.error(err));
                        }
                    }
                }
            }
        }
    }
})
</script>
