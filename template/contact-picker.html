<div class='rc-contact-picker'>
    <input  class='rc-input rc-input--clean rc-contact-picker__input' 
            data-info='input' 
            data-event='input:autoComplete|focus:autoComplete'>
    </input>
    <div class='rc-contacts rc-list' data-info='contacts'>
        <contact-picker-item dynamic></contact-picker-item>
    </div>
</div>
<script>
w.register(function() {
    var enlarge = w.transition('enlarge')
    this.actions = {
        init:{
            method: function(finish) {
                this.props.limit = 10;
                this.props.show = false;
                return finish();
            }
        },
        render: {
            method: function(finish) {
                finish();
            },
            after: function() {
                window.addEventListener('click', (e) => {
                    if (e.target !== this.props.dom.input && !e.target.classList.contains('contact')) {
                        this.hide();
                    }
                });
                enlarge.init(this.props.dom.contacts)
            }
        },
        hide: {
            after: function() {
                if (this.props.show) {
                    this.props.show = false;
                    enlarge.out(this.props.dom.contacts)
                }
            }
        },
        show: {
            after: function() {
                // if (this.showingTimeout) 
                //     return;
                // this.showingTimeout = window.setTimeout(() => {
                //     if (this.props.dom.input === document.activeElement) 
                //         enlarge.in(this.props.dom.contacts)
                // }, 300);
                if (!this.props.show) {
                    this.props.show = true;
                    enlarge.in(this.props.dom.contacts)
                }
            }
        },
        getInput: {
            method: function() {
                return this.props.dom.input.value;
            }
        },
        appendInput: {
            before: function(value) {
                this.props.dom.input.value += value;
                this.props.dom.input.focus();
            }
        },
        setInput: {
            before: function(value) {
                this.props.dom.input.value = value;
                this.props.dom.input.focus();
            }
        },
        autoComplete: {
            method: function(finish) {
                this.props.inputValue = this.props.dom.input.value;
                return finish();
            },
            after: function(contacts) {
                if (!contacts)
                    return;
                // while (this.props.dom.contacts.firstChild)
                //     this.props.dom.contacts.removeChild(this.props.dom.contacts.firstChild);
                if (contacts.length > 0)
                    this.show();
                else
                    this.hide();
                var count = 0;
                var parent = this;
                contacts.every(contact => {
                    if(count < this.props.limit){
                        var widget = w('contact-picker-item', {
                            actions: {
                                init: {
                                    method:function(){
                                        return contact;
                                    }
                                },
                                select: {
                                    method:function(){
                                        parent.setInput(this.props.value);
                                    }
                                }
                            }
                        });
                        widget.render(this.props.dom.contacts);    
                        count++;
                        return true;
                    }else{
                        return false;
                    }
                })
            }
        }
    }
})
</script>
