<template>
    <div class='rc-panel rc-call-panel'>
        <section data-info='header' class='rc-panel__header --colored --center'>
            <div
                data-info='time-wrapper' 
                class='text-right display-none'>
                <span data-info='time'></span>
            </div>
            <div>
                <h1 data-info='name'>Number</h1>
            </div>
        </section>
        <section data-info='content' class='rc-panel__content'>
            <div class='rc-call-panel__center control-panel'>
                <h4 class='control-panel__title'>
                </h4>
                <div class='control-panel__line'>
                    <div class='control-panel__item'>
                        <button 
                            data-info='hold'
                            class='rc-button --circle --ghost --dense rc-icon-switch control-panel__button'>
                            <span class="icon-uni28"></span>
                            <span class="icon-uni35"></span>
                        </button>
                        <div class='text-center'>Hold</div>
                    </div>
                    <div class='control-panel__item'>
                        <button class='rc-button --circle --ghost --dense rc-icon-switch control-panel__button'>
                            <span class="icon-uni21"></span>
                            <span class="icon-uni2D"></span>
                        </button>
                        <div class='text-center'>Keypad</div>
                    </div>
                    <div class='control-panel__item'>
                        <button 
                            data-info='record'
                            class='rc-button --circle --ghost --dense rc-icon-switch control-panel__button'>
                            <span class="icon-uni24"></span>
                            <span class="icon-uni30"></span>
                        </button>
                        <div class='text-center'>Record</div>
                    </div>
                    <div class='control-panel__item'>
                        <button class='rc-button --circle --ghost --dense rc-icon-switch control-panel__button'>
                            <span class="icon-uni26"></span>
                            <span class="icon-uni33"></span>
                        </button>
                        <div class='text-center'>Audio</div>
                    </div>
                </div>
                <div class='control-panel__line'>
                    <div class='control-panel__item'>
                        <button 
                            data-info='flip'
                            class='rc-button --circle --ghost --dense rc-icon-switch control-panel__button'>
                            <span class="icon-uni27"></span>
                            <span class="icon-uni34"></span>
                        </button>
                        <div class='text-center'>Flip</div>
                    </div>
                    <div class='control-panel__item'>
                        <button 
                            data-info='transfer'
                            class='rc-button --circle --ghost --dense rc-icon-switch control-panel__button'>
                            <span class="icon-uni23"></span>
                            <span class="icon-uni2F"></span>
                        </button>
                        <div class='text-center'>Transfer</div>
                    </div>
                    <div class='control-panel__item'>
                        <button
                            data-info='park'
                            class='rc-button --circle --ghost --dense rc-icon-switch control-panel__button'>
                            <span class="icon-uni22"></span>
                            <span class="icon-uni2E"></span>
                        </button>
                        <div class='text-center'>Park</div>
                    </div>
                </div>
            </div>
            <div class='rc-call-panel__footer'>
                <div class='action-panel'>
                    <button class='rc-button --round action-panel__action'>
                        <span class='icon-uniCE'></span>
                    </button>
                    <button 
                        data-info='hangup'
                        class='rc-button --negative --round action-panel__action'>
                        <span class='icon-uni44'></span>
                    </button>
                </div>
            </div>
        </section>
        <div
            data-info='bar' 
            class='bar display-none'>
            <span data-info='bar-name' class='bar__name'>bar</span>
            <span data-info='bar-time' class='bar__time'></span>
        </div>
    </div>
    <video data-info='local' class='display-none'></video>
    <video data-info='remote' class='display-none'></video>
</template>
<script>
var fade = w.transition('fade')
var _interval
this.props = {
    name: null,
    time: 0,
    minimized: false,
    width: 250,
    height: 400,
    target: null,
    remoteVideo: null,
    localVideo: null,
}
this.actions = {
    init: {
        after: function() {
            this.props.name = this.data.name
            this.props.width = this.data.width
            this.props.height = this.data.height
            this.props.target = this.data.target
            this.props.remoteVideo = this.dom.remote
            this.props.localVideo = this.dom.local

            this.root.firstChild.style.width = this.props.width + 'px'
            this.root.firstChild.style.height = this.props.height + 'px'
        }
    },
    mount: {
        after: function () {
            fade.init(this.root)
            fade.in(this.root)
            this.props.name && this.setName(this.props.name)
        }
    },
    unmount: {
        after: function() {
            this.dom.time.textContent = '0:0'
            this.props.duration = 0
            if (_interval) {
                // clear interval
                _interval()
                _interval = null
            }
        }
    },
    setName: {
        method: function(finish, value) {
            this.props.name = value
            this.dom.name.textContent = value
            this.dom['bar-name'].textContent = value
        }
    },
    start: {
        after: function(time) {
            this.dom['time-wrapper'].classList.remove('display-none')
            this.props.startTime = Date.now()
            this.props.duration = 0
            var minutes = Math.floor(this.props.duration / 60)
            var seconds = this.props.duration % 60
            this.dom['time'].textContent = `${minutes}:${seconds}`
            // FIXME: NOT accurate
            // TODO: check for real startTime from SIP
            _interval = (function(self) {
                var id = setInterval(() => {
                    self.count()
                }, 1000)
                return function() {
                    clearInterval(id)
                }
            }(this))
            
        }
    },
    count: {
        after: function() {
            this.props.duration += 1
            var minutes = Math.floor(this.props.duration / 60)
            var seconds = this.props.duration % 60
            this.dom.time.textContent = `${minutes}:${seconds}`
            this.dom['bar-time'].textContent = `${minutes}:${seconds}`
        }
    },
    ended: {
        after: function() {
            this.unmount()
        }
    },
    hangup: {
        method: function(finish) {
            return finish()
        },
        after: function() {
            this.ended()
        }
    },
    hold: {
        method: function(finish) {
            console.log('ui hold');
            return finish()
        }
    },
    mute: {
        method: function(finish) {
            console.log('ui mute');
            return finish()
        }
    },
    flip: {
        method: function(finish, number) {
            console.log('ui flip');
            return finish()
        }
    },
    forward: {
        method: function(finish, number) {
            console.log('ui forward');
            return finish()
        }
    },
    record: {
        method: function(finish) {
            console.log('ui record');
            return finish()
        }
    },
    minimize: {
        after: function() {
            this.dom.bar.classList.remove('display-none')
            this.dom.header.classList.add('display-none')
            this.dom.content.classList.add('display-none')
            this.root.firstChild.style.height = 'auto'
            this.props.minimized = true
        }
    },
    resume: {
        after: function() {
            this.dom.bar.classList.add('display-none')
            this.dom.header.classList.remove('display-none')
            this.dom.content.classList.remove('display-none')
            this.root.firstChild.style.height = this.props.height + 'px'
            this.props.minimized = false
        }
    }
}
this.on('click', function(e) {
    ['hangup', 'hold', 'mute', 'flip', 'forward', 'record'].forEach(action => {
        if (e.target === this.dom[action] || e.target.parentNode === this.dom[action])
            this[action]()
    })
    if (e.target === this.dom.bar)
        this.resume()
})
//# sourceURL=call-panel.html
</script>
<style scoped>
@import "src/styles/variables.css";
@import "src/styles/mixins.css";
    .bar {
        width: 100%;
        height: 30px;
        background-color: $red;
        text-align: center;
        line-height: 2;
        color: #fff;
        cursor: pointer;
        &__name {
            margin-right: 10px;
        }
    }
</style>
