{"version":3,"sources":["modules/ProxyFrameOAuth/index.js"],"names":["DEFAULT_PROXY_RETRY","ProxyFrameOAuth","name","deps","dep","optional","redirectUri","proxyUri","defaultProxyRetry","options","_callbackHandler","origin","data","callbackUri","proxyLoaded","_handleCallbackUri","clearTimeout","_retryTimeoutId","store","dispatch","type","actionTypes","setupOAuth","_createProxyFrame","_proxyFrame","document","createElement","src","style","display","setAttribute","join","body","appendChild","window","addEventListener","setTimeout","_retrySetupProxyFrame","_defaultProxyRetry","_uuid","v4","_proxyUri","_reducer","oAuthReady","proxyRetry","_destroyProxyFrame","removeChild","removeEventListener","setupProxy","destroyOAuth","contentWindow","postMessage","oAuthUri","resolve","location","href","encodeURIComponent","btoa","prefix","state","proxyRetryCount"],"mappings":"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","file":"index.js","sourcesContent":["import background from 'ringcentral-integration/lib/background';\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\nimport url from 'url';\nimport uuid from 'uuid';\nimport actionTypes from './actionTypes';\nimport getProxyFrameOAuthReducer from './getProxyFrameOAuthReducer';\n\nimport OAuthBase from '../../lib/OAuthBase';\n\nconst DEFAULT_PROXY_RETRY = 5000;\n\n@Module({\n  name: 'OAuth',\n  deps: [\n    { dep: 'OAuthOptions', optional: true },\n  ],\n})\nexport default class ProxyFrameOAuth extends OAuthBase {\n  constructor({\n    redirectUri = './redirect.html',\n    proxyUri = './proxy.html',\n    defaultProxyRetry = DEFAULT_PROXY_RETRY,\n    ...options\n  }) {\n    super({\n      redirectUri,\n      ...options,\n    });\n    this._uuid = uuid.v4();\n    this._proxyUri = ensureExist(proxyUri, 'proxyUri');\n    this._defaultProxyRetry = defaultProxyRetry;\n\n    this._reducer = getProxyFrameOAuthReducer(this.actionTypes);\n  }\n\n  get name() {\n    return 'proxyFrameOAuth';\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  get proxyUri() {\n    return `${url.resolve(window.location.href, this._proxyUri)}?hash=${encodeURIComponent(btoa(this._uuid))}&prefix=${encodeURIComponent(this.prefix)}`;\n  }\n\n  get proxyRetryCount() {\n    return this.state.proxyRetryCount;\n  }\n\n  _callbackHandler = async ({ origin, data }) => {\n    // TODO origin check\n    if (data) {\n      const {\n        callbackUri,\n        proxyLoaded,\n      } = data;\n      if (\n        callbackUri\n      ) {\n        this._handleCallbackUri(callbackUri);\n      } else if (proxyLoaded) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n        this.store.dispatch({\n          type: this.actionTypes.setupOAuth,\n        });\n      }\n    }\n  }\n  _createProxyFrame = () => {\n    this._proxyFrame = document.createElement('iframe');\n    this._proxyFrame.src = this.proxyUri;\n    this._proxyFrame.style.display = 'none';\n    this._proxyFrame.setAttribute('sandbox', [\n      'allow-scripts',\n      'allow-popups',\n      'allow-same-origin',\n      'allow-forms',\n    ].join(' '));\n    document.body.appendChild(this._proxyFrame);\n    window.addEventListener('message', this._callbackHandler);\n    this._retryTimeoutId = setTimeout(() => {\n      this._retrySetupProxyFrame();\n    }, this._defaultProxyRetry);\n  }\n  _retrySetupProxyFrame() {\n    this._retryTimeoutId = null;\n    if (!this.oAuthReady) {\n      this.store.dispatch({\n        type: this.actionTypes.proxyRetry,\n      });\n      this._destroyProxyFrame();\n      this._createProxyFrame();\n    }\n  }\n  _destroyProxyFrame() {\n    document.body.removeChild(this._proxyFrame);\n    this._proxyFrame = null;\n    window.removeEventListener('message', this._callbackHandler);\n  }\n\n  @background\n  async setupOAuth() {\n    if (\n      !this._proxyFrame\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.setupProxy,\n      });\n      this._createProxyFrame();\n    }\n  }\n\n  @background\n  async destroyOAuth() {\n    if (this._proxyFrame) {\n      if (this._retryTimeoutId) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n      }\n      this._destroyProxyFrame();\n      this.store.dispatch({\n        type: this.actionTypes.destroyOAuth,\n      });\n    }\n  }\n\n  @proxify\n  openOAuthPage() {\n    if (this.oAuthReady) {\n      this._proxyFrame.contentWindow.postMessage({\n        oAuthUri: this.oAuthUri,\n      }, '*');\n    }\n  }\n}\n"]}