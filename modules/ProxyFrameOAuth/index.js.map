{"version":3,"sources":["modules/ProxyFrameOAuth/index.js"],"names":["DEFAULT_PROXY_RETRY","ProxyFrameOAuth","name","deps","dep","optional","redirectUri","proxyUri","defaultProxyRetry","options","_callbackHandler","origin","data","callbackUri","proxyLoaded","fromLocalStorage","_tabManager","active","_handleCallbackUri","clearTimeout","_retryTimeoutId","store","dispatch","type","actionTypes","setupOAuth","_createProxyFrame","_proxyFrame","document","createElement","src","style","display","setAttribute","join","body","appendChild","window","addEventListener","setTimeout","_retrySetupProxyFrame","_defaultProxyRetry","_proxyUri","_reducer","oAuthReady","proxyRetry","_destroyProxyFrame","removeChild","removeEventListener","setupProxy","destroyOAuth","contentWindow","postMessage","oAuthUri","resolve","location","href","state","proxyRetryCount"],"mappings":"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","file":"index.js","sourcesContent":["import background from 'ringcentral-integration/lib/background';\r\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\r\nimport { Module } from 'ringcentral-integration/lib/di';\r\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\r\nimport url from 'url';\r\nimport actionTypes from './actionTypes';\r\nimport getProxyFrameOAuthReducer from './getProxyFrameOAuthReducer';\r\n\r\nimport OAuthBase from '../../lib/OAuthBase';\r\n\r\nconst DEFAULT_PROXY_RETRY = 5000;\r\n\r\n@Module({\r\n  name: 'OAuth',\r\n  deps: [\r\n    { dep: 'OAuthOptions', optional: true },\r\n  ],\r\n})\r\nexport default class ProxyFrameOAuth extends OAuthBase {\r\n  constructor({\r\n    redirectUri = './redirect.html',\r\n    proxyUri = './proxy.html',\r\n    defaultProxyRetry = DEFAULT_PROXY_RETRY,\r\n    ...options\r\n  }) {\r\n    super({\r\n      redirectUri,\r\n      ...options,\r\n    });\r\n    this._proxyUri = ensureExist(proxyUri, 'proxyUri');\r\n    this._defaultProxyRetry = defaultProxyRetry;\r\n\r\n    this._reducer = getProxyFrameOAuthReducer(this.actionTypes);\r\n  }\r\n\r\n  get name() {\r\n    return 'proxyFrameOAuth';\r\n  }\r\n\r\n  get _actionTypes() {\r\n    return actionTypes;\r\n  }\r\n\r\n  get proxyUri() {\r\n    return url.resolve(window.location.href, this._proxyUri);\r\n  }\r\n\r\n  get proxyRetryCount() {\r\n    return this.state.proxyRetryCount;\r\n  }\r\n\r\n  _callbackHandler = async ({ origin, data }) => {\r\n    // TODO origin check\r\n    if (data) {\r\n      const {\r\n        callbackUri,\r\n        proxyLoaded,\r\n        fromLocalStorage,\r\n      } = data;\r\n      if (\r\n        callbackUri &&\r\n        (\r\n          fromLocalStorage !== true ||\r\n          (!this._tabManager || this._tabManager.active)\r\n        )\r\n      ) {\r\n        this._handleCallbackUri(callbackUri);\r\n      } else if (proxyLoaded) {\r\n        clearTimeout(this._retryTimeoutId);\r\n        this._retryTimeoutId = null;\r\n        this.store.dispatch({\r\n          type: this.actionTypes.setupOAuth,\r\n        });\r\n      }\r\n    }\r\n  }\r\n  _createProxyFrame = () => {\r\n    this._proxyFrame = document.createElement('iframe');\r\n    this._proxyFrame.src = this.proxyUri;\r\n    this._proxyFrame.style.display = 'none';\r\n    this._proxyFrame.setAttribute('sandbox', [\r\n      'allow-scripts',\r\n      'allow-popups',\r\n      'allow-same-origin',\r\n      'allow-forms',\r\n    ].join(' '));\r\n    document.body.appendChild(this._proxyFrame);\r\n    window.addEventListener('message', this._callbackHandler);\r\n    this._retryTimeoutId = setTimeout(() => {\r\n      this._retrySetupProxyFrame();\r\n    }, this._defaultProxyRetry);\r\n  }\r\n  _retrySetupProxyFrame() {\r\n    this._retryTimeoutId = null;\r\n    if (!this.oAuthReady) {\r\n      this.store.dispatch({\r\n        type: this.actionTypes.proxyRetry,\r\n      });\r\n      this._destroyProxyFrame();\r\n      this._createProxyFrame();\r\n    }\r\n  }\r\n  _destroyProxyFrame() {\r\n    document.body.removeChild(this._proxyFrame);\r\n    this._proxyFrame = null;\r\n    window.removeEventListener('message', this._callbackHandler);\r\n  }\r\n\r\n  @background\r\n  async setupOAuth() {\r\n    if (\r\n      !this._proxyFrame\r\n    ) {\r\n      this.store.dispatch({\r\n        type: this.actionTypes.setupProxy,\r\n      });\r\n      this._createProxyFrame();\r\n    }\r\n  }\r\n\r\n  @background\r\n  async destroyOAuth() {\r\n    if (this._proxyFrame) {\r\n      if (this._retryTimeoutId) {\r\n        clearTimeout(this._retryTimeoutId);\r\n        this._retryTimeoutId = null;\r\n      }\r\n      this._destroyProxyFrame();\r\n      this.store.dispatch({\r\n        type: this.actionTypes.destroyOAuth,\r\n      });\r\n    }\r\n  }\r\n\r\n  @proxify\r\n  openOAuthPage() {\r\n    if (this.oAuthReady) {\r\n      this._proxyFrame.contentWindow.postMessage({\r\n        oAuthUri: this.oAuthUri,\r\n      }, '*');\r\n    }\r\n  }\r\n}\r\n"]}