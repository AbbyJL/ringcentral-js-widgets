{"version":3,"sources":["modules/UserGuide/index.js"],"names":["SUPPORTED_LOCALES","UserGuide","deps","dep","optional","auth","locale","storage","webphone","rolesAndPermissions","options","actionTypes","_auth","_locale","_storage","_webphone","_rolesAndPermissions","_reducer","_context","context","_storageKey","_guideReducer","registerReducer","key","reducer","store","subscribe","_onStateChange","pending","ready","loggedIn","dispatch","type","initSuccess","initUserGuide","resetSuccess","ringSession","_lastRingSession","dismiss","locales","keys","sort","map","reduce","prev","curr","forEach","includes","push","updateCarousel","curIdx","entered","playing","guides","loadGuides","hasUserGuidePermission","prevGuides","allGuides","resolveGuides","start","length","currentLocale","getItem","state","carouselState","status","RcModule","proxify"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport actionTypes from './actionTypes';\nimport getUserGuideReducer, { getGuidesReducer } from './getUserGuideReducer';\n\n/**\n * Support localization\n */\nconst SUPPORTED_LOCALES = {\n  'en-US': 'en-US',\n  'fr-CA': 'fr-CA',\n};\n\n@Module({\n  deps: [\n    'Auth',\n    'Locale',\n    'Storage',\n    'Webphone',\n    'RolesAndPermissions',\n    { dep: 'UserGuideOptions', optional: true }\n  ]\n})\nexport default class UserGuide extends RcModule {\n  constructor({\n    auth,\n    locale,\n    storage,\n    webphone,\n    rolesAndPermissions,\n    ...options\n  }) {\n    super({\n      actionTypes,\n      ...options\n    });\n    this._auth = auth;\n    this._locale = locale;\n    this._storage = storage;\n    this._webphone = webphone;\n    this._rolesAndPermissions = rolesAndPermissions;\n    this._reducer = getUserGuideReducer(this.actionTypes);\n\n    this._context = options.context;\n\n    this._storageKey = 'userGuide';\n    this._guideReducer = getGuidesReducer(this.actionTypes);\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: this._guideReducer,\n    });\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (\n      this.pending &&\n      this._auth.ready &&\n      this._locale.ready &&\n      this._storage.ready &&\n      this._rolesAndPermissions.ready &&\n      this._auth.loggedIn\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      await this.initUserGuide();\n    } else if (\n      this.ready && (\n        !this._auth.ready ||\n        !this._locale.ready ||\n        !this._storage.ready ||\n        !this._rolesAndPermissions.ready\n      )\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess\n      });\n    }\n    // When there is an incoming call,\n    // the guide should be dismissed\n    if (\n      this._webphone.ready &&\n      this._webphone.ringSession &&\n      this._webphone.ringSession !== this._lastRingSession\n    ) {\n      this._lastRingSession = this._webphone.ringSession;\n      this.dismiss();\n    }\n  }\n\n  /**\n   * Using webpack `require.context` to load guides files.\n   * Image files will be ordered by file name ascendingly.\n   * @return {Map<String, Array<URI>>}\n   */\n  resolveGuides() {\n    if (this._context && typeof this._context === 'function') {\n      const locales = Object.keys(SUPPORTED_LOCALES);\n      return this._context.keys().sort()\n        .map(key => this._context(key))\n        .reduce((prev, curr) => {\n          locales.forEach((locale) => {\n            if (!prev[locale]) prev[locale] = [];\n            if (curr.includes(locale)) {\n              prev[locale].push(curr);\n            }\n          });\n          return prev;\n        }, {});\n    }\n    return {};\n  }\n\n  @proxify\n  dismiss() {\n    this.updateCarousel({ curIdx: 0, entered: false, playing: false });\n  }\n\n  @proxify\n  async loadGuides(guides) {\n    if (guides) {\n      this.store.dispatch({\n        type: this.actionTypes.loadGuides,\n        guides\n      });\n    }\n  }\n\n  @proxify\n  async updateCarousel({ curIdx, entered, playing }) {\n    this.store.dispatch({\n      type: this.actionTypes.updateCarousel,\n      curIdx,\n      entered,\n      playing\n    });\n  }\n\n  @proxify\n  async initUserGuide() {\n    if (!this._rolesAndPermissions.hasUserGuidePermission) return;\n    // eslint-disable-next-line\n    const prevGuides = this.allGuides;\n    const guides = this.resolveGuides();\n    // Determine if it needs to be displayed when first log in,\n    // the principles behind this is to use webpack's file hash,\n    // i.e. if any of the guide files is changed, the file name hash\n    // will be changed as well, in this case, it will be displayed.\n    await this.loadGuides(guides);\n    if (JSON.stringify(guides) !== JSON.stringify(prevGuides)) {\n      await this.start();\n    }\n  }\n\n  @proxify\n  async start() {\n    // Start guides only when images are ready\n    if (this.guides.length > 0) {\n      this.store.dispatch({\n        type: this.actionTypes.updateCarousel,\n        curIdx: 0,\n        entered: true,\n        playing: true,\n      });\n    }\n  }\n\n  get guides() {\n    if (!this._locale.ready) return [];\n    if (this.allGuides) {\n      return this.allGuides[this._locale.currentLocale] ||\n        this.allGuides[SUPPORTED_LOCALES['en-US']] || [];\n    }\n    return [];\n  }\n\n  get allGuides() {\n    if (!this._storage.ready) return [];\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get carouselState() {\n    return this.state.carouselState;\n  }\n\n  get started() {\n    return this.carouselState.entered && this.carouselState.playing;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n}\n"]}