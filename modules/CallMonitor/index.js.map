{"version":3,"sources":["modules/CallMonitor/index.js"],"names":["matchWephoneSessionWithAcitveCall","sessions","callItem","sipData","undefined","find","session","direction","callDirections","inbound","remoteUri","indexOf","from","outbound","to","webphoneStartTime","creationTime","startTime","Math","abs","CallMonitor","deps","dep","optional","call","accountInfo","detailedPresence","activityMatcher","contactMatcher","tabManager","webphone","onRinging","onNewCall","onCallUpdated","onCallEnded","storage","options","actionTypes","_call","_accountInfo","ensureExist","_detailedPresence","_contactMatcher","_activityMatcher","_tabManager","_webphone","_onRinging","_onNewCall","_onCallUpdated","_onCallEnded","_storage","_callMatchedKey","_reducer","registerReducer","key","reducer","addSelector","calls","countryCode","callsFromPresence","sessionsCache","map","fromNumber","phoneNumber","toNumber","webphoneSession","filter","x","sort","sortByStartTime","_selectors","normalizedCalls","dataMapping","callMatched","contactMapping","activityMapping","fromMatches","toMatches","toNumberEntity","sessionId","activityMatches","lastEndedSessions","endCall","output","numberMap","addIfNotExist","number","push","forEach","addQuerySource","getQueriesFn","uniqueNumbers","readyCheckFn","ready","sessionIds","_lastProcessedNumbers","_lastProcessedCalls","_lastProcessedIds","pending","store","dispatch","type","init","initSuccess","reset","resetSuccess","active","triggerMatch","oldCalls","slice","length","toNumberEntities","cleanToNumberEntities","entities","oldCallIndex","findIndex","item","oldCall","splice","telephonyStatus","entity","index","toEntity","toMatch","id","entityId","_removeMatched","_setMatchedData","toEntityId","subscribe","_onStateChange","console","log","matched","setData","state","status","moduleStatuses","getItem","activeRingCalls","activeOnHoldCalls","activeCurrentCalls","otherDeviceCalls","RcModule"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAGA;;;;AACA;;AAKA;;;;AACA;;;;AAEA,SAASA,iCAAT,CAA2CC,QAA3C,EAAqDC,QAArD,EAA+D;AAC7D,MAAI,CAACD,QAAD,IAAa,CAACC,SAASC,OAA3B,EAAoC;AAClC,WAAOC,SAAP;AACD;AACD,SAAOH,SAASI,IAAT,CAAc,UAACC,OAAD,EAAa;AAChC,QAAIA,QAAQC,SAAR,KAAsBL,SAASK,SAAnC,EAA8C;AAC5C,aAAO,KAAP;AACD;AACD,QACED,QAAQC,SAAR,KAAsBC,yBAAeC,OAArC,IACAP,SAASC,OAAT,CAAiBO,SAAjB,CAA2BC,OAA3B,CAAmCL,QAAQM,IAA3C,MAAqD,CAAC,CAFxD,EAGE;AACA,aAAO,KAAP;AACD;AACD,QACEN,QAAQC,SAAR,KAAsBC,yBAAeK,QAArC,IACAX,SAASC,OAAT,CAAiBO,SAAjB,CAA2BC,OAA3B,CAAmCL,QAAQQ,EAA3C,MAAmD,CAAC,CAFtD,EAGE;AACA,aAAO,KAAP;AACD;AACD,QAAIC,0BAAJ;AACA,QAAIT,QAAQC,SAAR,KAAsBC,yBAAeC,OAAzC,EAAkD;AAChDM,0BAAoBT,QAAQU,YAA5B;AACD,KAFD,MAEO;AACLD,0BAAoBT,QAAQW,SAAR,IAAqBX,QAAQU,YAAjD;AACD;AACD;AACA;AACA;AACA,QACEE,KAAKC,GAAL,CAASjB,SAASe,SAAT,GAAqBF,iBAA9B,IAAmD,KADrD,EAEE;AACA,aAAO,KAAP;AACD;AACD,WAAO,IAAP;AACD,GA/BM,CAAP;AAgCD;;AAED;;;;IAiBqBK,W,WAbpB,gBAAO;AACNC,QAAM,CACJ,aADI,EAEJ,SAFI,EAGJ,kBAHI,EAIJ,EAAEC,KAAK,gBAAP,EAAyBC,UAAU,IAAnC,EAJI,EAKJ,EAAED,KAAK,UAAP,EAAmBC,UAAU,IAA7B,EALI,EAMJ,EAAED,KAAK,MAAP,EAAeC,UAAU,IAAzB,EANI,EAOJ,EAAED,KAAK,iBAAP,EAA0BC,UAAU,IAApC,EAPI,EAQJ,EAAED,KAAK,oBAAP,EAA6BC,UAAU,IAAvC,EARI,EASJ,EAAED,KAAK,YAAP,EAAqBC,UAAU,IAA/B,EATI;AADA,CAAP,C;;;AAcC;;;;;;;;;;;;;;;AAeA,6BAcG;AAAA,QAbDC,IAaC,QAbDA,IAaC;AAAA,QAZDC,WAYC,QAZDA,WAYC;AAAA,QAXDC,gBAWC,QAXDA,gBAWC;AAAA,QAVDC,eAUC,QAVDA,eAUC;AAAA,QATDC,cASC,QATDA,cASC;AAAA,QARDC,UAQC,QARDA,UAQC;AAAA,QAPDC,QAOC,QAPDA,QAOC;AAAA,QANDC,SAMC,QANDA,SAMC;AAAA,QALDC,SAKC,QALDA,SAKC;AAAA,QAJDC,aAIC,QAJDA,aAIC;AAAA,QAHDC,WAGC,QAHDA,WAGC;AAAA,QAFDC,OAEC,QAFDA,OAEC;AAAA,QADEC,OACF;AAAA;;AAAA,2KAEIA,OAFJ;AAGCC;AAHD;;AAKD,UAAKC,KAAL,GAAad,IAAb;AACA,UAAKe,YAAL,GAA0BC,qBAAN,aAAkBf,WAAlB,EAA+B,aAA/B,CAApB;AACA,UAAKgB,iBAAL,GAA+BD,qBAAN,aAAkBd,gBAAlB,EAAoC,kBAApC,CAAzB;AACA,UAAKgB,eAAL,GAAuBd,cAAvB;AACA,UAAKe,gBAAL,GAAwBhB,eAAxB;AACA,UAAKiB,WAAL,GAAmBf,UAAnB;AACA,UAAKgB,SAAL,GAAiBf,QAAjB;AACA,UAAKgB,UAAL,GAAkBf,SAAlB;AACA,UAAKgB,UAAL,GAAkBf,SAAlB;AACA,UAAKgB,cAAL,GAAsBf,aAAtB;AACA,UAAKgB,YAAL,GAAoBf,WAApB;AACA,UAAKgB,QAAL,GAAsBV,qBAAN,aAAkBL,OAAlB,EAA2B,SAA3B,CAAhB;AACA,UAAKgB,eAAL,GAAuB,aAAvB;;AAEA,UAAKC,QAAL,GAAgB,qCAAsB,MAAKf,WAA3B,CAAhB;;AAEA,UAAKa,QAAL,CAAcG,eAAd,CAA8B;AAC5BC,WAAK,MAAKH,eADkB;AAE5BI,eAAS,kDAAsB,MAAKlB,WAA3B;AAFmB,KAA9B;;AAMA,UAAKmB,WAAL,CAAiB,iBAAjB,EACE;AAAA,aAAM,MAAKf,iBAAL,CAAuBgB,KAA7B;AAAA,KADF,EAEE;AAAA,aAAM,MAAKlB,YAAL,CAAkBmB,WAAxB;AAAA,KAFF,EAGE;AAAA,aAAM,MAAKb,SAAL,IAAkB,MAAKA,SAAL,CAAe5C,QAAvC;AAAA,KAHF,EAIE,UAAC0D,iBAAD,EAAoBD,WAApB,EAAiCzD,QAAjC,EAA8C;AAC5C,UAAI2D,gBAAgB3D,QAApB;AACA,aAAO0D,kBAAkBE,GAAlB,CAAsB,UAAC3D,QAAD,EAAc;AACzC;AACA,YAAM4D,aAAa,+BAAgB;AACjCC,uBAAa7D,SAASU,IAAT,IAAiBV,SAASU,IAAT,CAAcmD,WADX;AAEjCL;AAFiC,SAAhB,CAAnB;AAIA,YAAMM,WAAW,+BAAgB;AAC/BD,uBAAa7D,SAASY,EAAT,IAAeZ,SAASY,EAAT,CAAYiD,WADT;AAE/BL;AAF+B,SAAhB,CAAjB;AAIA,YAAMO,kBAAkBjE,kCAAkC4D,aAAlC,EAAiD1D,QAAjD,CAAxB;AACA0D,wBAAgBA,cAAcM,MAAd,CAAqB;AAAA,iBAAKC,MAAMF,eAAX;AAAA,SAArB,CAAhB;AACA,0CACK/D,QADL;AAEEU,gBAAM;AACJmD,yBAAaD;AADT,WAFR;AAKEhD,cAAI;AACFiD,yBAAaC;AADX,WALN;AAQE/C,qBACGgD,mBAAmBA,gBAAgBhD,SAApC,IACAf,SAASe,SAVb;AAYEgD;AAZF;AAcD,OA1BM,EA0BJG,IA1BI,CA0BCC,+BA1BD,CAAP;AA2BD,KAjCH;;AAoCA,UAAKb,WAAL,CAAiB,OAAjB,EACE,MAAKc,UAAL,CAAgBC,eADlB,EAEE;AAAA,aAAO,MAAK7B,eAAL,IAAwB,MAAKA,eAAL,CAAqB8B,WAApD;AAAA,KAFF,EAGE;AAAA,aAAO,MAAK7B,gBAAL,IAAyB,MAAKA,gBAAL,CAAsB6B,WAAtD;AAAA,KAHF,EAIE;AAAA,aAAO,MAAKC,WAAZ;AAAA,KAJF,EAKE,UAACF,eAAD,EAA6E;AAAA,UAA3DG,cAA2D,uEAA1C,EAA0C;AAAA,UAAtCC,eAAsC,uEAApB,EAAoB;AAAA,UAAhBF,WAAgB;;AAC3E,UAAMhB,QAAQc,gBAAgBV,GAAhB,CAAoB,UAAC3D,QAAD,EAAc;AAC9C,YAAM4D,aAAa5D,SAASU,IAAT,IAAiBV,SAASU,IAAT,CAAcmD,WAAlD;AACA,YAAMC,WAAW9D,SAASY,EAAT,IAAeZ,SAASY,EAAT,CAAYiD,WAA5C;AACA,YAAMa,cAAed,cAAcY,eAAeZ,UAAf,CAAf,IAA8C,EAAlE;AACA,YAAMe,YAAab,YAAYU,eAAeV,QAAf,CAAb,IAA0C,EAA5D;AACA,YAAMc,iBAAiBL,YAAYvE,SAAS6E,SAArB,CAAvB;AACA,0CACK7E,QADL;AAEE0E,kCAFF;AAGEC,8BAHF;AAIEG,2BAAkBL,gBAAgBzE,SAAS6E,SAAzB,CAAD,IAAyC,EAJ5D;AAKED;AALF;AAOD,OAba,CAAd;AAcA,aAAOrB,KAAP;AACD,KArBH;;AAwBA,UAAKD,WAAL,CAAiB,iBAAjB,EACE,MAAKc,UAAL,CAAgBb,KADlB,EAEE;AAAA,aAASA,MAAMS,MAAN,CAAa;AAAA,eACpBhE,SAAS+D,eAAT,IAA4B,4BAAO/D,SAAS+D,eAAhB,CADR;AAAA,OAAb,CAAT;AAAA,KAFF;;AAOA,UAAKT,WAAL,CAAiB,mBAAjB,EACE,MAAKc,UAAL,CAAgBb,KADlB,EAEE;AAAA,aAASA,MAAMS,MAAN,CAAa;AAAA,eACpBhE,SAAS+D,eAAT,IAA4B,8BAAS/D,SAAS+D,eAAlB,CADR;AAAA,OAAb,CAAT;AAAA,KAFF;;AAOA,UAAKT,WAAL,CAAiB,oBAAjB,EACE,MAAKc,UAAL,CAAgBb,KADlB,EAEE;AAAA,aAASA,MAAMS,MAAN,CAAa;AAAA,eACpBhE,SAAS+D,eAAT,IACA,CAAC,8BAAS/D,SAAS+D,eAAlB,CADD,IAEA,CAAC,4BAAO/D,SAAS+D,eAAhB,CAHmB;AAAA,OAAb,CAAT;AAAA,KAFF;;AASA,UAAKT,WAAL,CAAiB,kBAAjB,EACE,MAAKc,UAAL,CAAgBb,KADlB,EAEE;AAAA,aAAM,MAAKZ,SAAL,IAAkB,MAAKA,SAAL,CAAeoC,iBAAvC;AAAA,KAFF,EAGE,UAACxB,KAAD,EAAQwB,iBAAR,EAA8B;AAC5B,UAAIrB,gBAAgBqB,iBAApB;AACA,aAAOxB,MAAMS,MAAN,CAAa,UAAChE,QAAD,EAAc;AAChC,YAAIA,SAAS+D,eAAb,EAA8B;AAC5B,iBAAO,KAAP;AACD;AACD,YAAI,CAACL,aAAL,EAAoB;AAClB,iBAAO,IAAP;AACD;AACD,YAAMsB,UAAUlF,kCAAkC4D,aAAlC,EAAiD1D,QAAjD,CAAhB;AACA0D,wBAAgBA,cAAcM,MAAd,CAAqB;AAAA,iBAAKC,MAAMe,OAAX;AAAA,SAArB,CAAhB;AACA,eAAO,CAACA,OAAR;AACD,OAVM,CAAP;AAWD,KAhBH;;AAmBA,UAAK1B,WAAL,CAAiB,eAAjB,EACE,MAAKc,UAAL,CAAgBC,eADlB,EAEE,UAACA,eAAD,EAAqB;AACnB,UAAMY,SAAS,EAAf;AACA,UAAMC,YAAY,EAAlB;AACA,eAASC,aAAT,CAAuBC,MAAvB,EAA+B;AAC7B,YAAI,CAACF,UAAUE,MAAV,CAAL,EAAwB;AACtBH,iBAAOI,IAAP,CAAYD,MAAZ;AACAF,oBAAUE,MAAV,IAAoB,IAApB;AACD;AACF;AACDf,sBAAgBiB,OAAhB,CAAwB,UAACtF,QAAD,EAAc;AACpC,YAAIA,SAASU,IAAT,IAAiBV,SAASU,IAAT,CAAcmD,WAAnC,EAAgD;AAC9CsB,wBAAcnF,SAASU,IAAT,CAAcmD,WAA5B;AACD;AACD,YAAI7D,SAASY,EAAT,IAAeZ,SAASY,EAAT,CAAYiD,WAA/B,EAA4C;AAC1CsB,wBAAcnF,SAASY,EAAT,CAAYiD,WAA1B;AACD;AACF,OAPD;AAQA,aAAOoB,MAAP;AACD,KApBH;;AAuBA,QAAI,MAAKzC,eAAT,EAA0B;AACxB,YAAKA,eAAL,CAAqB+C,cAArB,CAAoC;AAClCC,sBAAc,MAAKpB,UAAL,CAAgBqB,aADI;AAElCC,sBAAc;AAAA,iBACZ,MAAKrD,YAAL,CAAkBsD,KAAlB,IACA,MAAKpD,iBAAL,CAAuBoD,KAFX;AAAA;AAFoB,OAApC;AAOD;;AAED,UAAKrC,WAAL,CAAiB,YAAjB,EACE;AAAA,aAAM,MAAKf,iBAAL,CAAuBgB,KAA7B;AAAA,KADF,EAEE;AAAA,aAASA,MAAMI,GAAN,CAAU;AAAA,eAAY3D,SAAS6E,SAArB;AAAA,OAAV,CAAT;AAAA,KAFF;;AAKA,QAAI,MAAKpC,gBAAT,EAA2B;AACzB,YAAKA,gBAAL,CAAsB8C,cAAtB,CAAqC;AACnCC,sBAAc,MAAKpB,UAAL,CAAgBwB,UADK;AAEnCF,sBAAc;AAAA,iBAAM,MAAKnD,iBAAL,CAAuBoD,KAA7B;AAAA;AAFqB,OAArC;AAID;;AAED,UAAKE,qBAAL,GAA6B,IAA7B;AACA,UAAKC,mBAAL,GAA2B,IAA3B;AACA,UAAKC,iBAAL,GAAyB,IAAzB;AAhLC;AAiLF;;;;;;;;;;;;;AAGC,oBACE,CAAC,CAAC,KAAK3D,KAAN,IAAe,KAAKA,KAAL,CAAWuD,KAA3B,KACA,KAAKtD,YAAL,CAAkBsD,KADlB,IAEA,KAAKpD,iBAAL,CAAuBoD,KAFvB,KAGC,CAAC,KAAKnD,eAAN,IAAyB,KAAKA,eAAL,CAAqBmD,KAH/C,MAIC,CAAC,KAAKlD,gBAAN,IAA0B,KAAKA,gBAAL,CAAsBkD,KAJjD,MAKC,CAAC,KAAKjD,WAAN,IAAqB,KAAKA,WAAL,CAAiBiD,KALvC,KAMA,KAAK3C,QAAL,CAAc2C,KANd,IAOA,KAAKK,OARP,EASE;AACA,uBAAKC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKhE,WAAL,CAAiBiE;AADL,mBAApB;AAGA,uBAAKH,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKhE,WAAL,CAAiBkE;AADL,mBAApB;AAGD,iBAhBD,MAgBO,IACL,CACG,KAAKjE,KAAL,IAAc,CAAC,KAAKA,KAAL,CAAWuD,KAA3B,IACA,CAAC,KAAKtD,YAAL,CAAkBsD,KADnB,IAEA,CAAC,KAAKpD,iBAAL,CAAuBoD,KAFxB,IAGC,KAAKnD,eAAL,IAAwB,CAAC,KAAKA,eAAL,CAAqBmD,KAH/C,IAIC,KAAKlD,gBAAL,IAAyB,CAAC,KAAKA,gBAAL,CAAsBkD,KAJjD,IAKC,KAAKjD,WAAL,IAAoB,CAAC,KAAKA,WAAL,CAAiBiD,KALvC,IAMA,CAAC,KAAK3C,QAAL,CAAc2C,KAPjB,KASA,KAAKA,KAVA,EAWL;AACA,uBAAKM,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKhE,WAAL,CAAiBmE;AADL,mBAApB;AAGA,uBAAKR,mBAAL,GAA2B,IAA3B;AACA,uBAAKC,iBAAL,GAAyB,IAAzB;AACA,uBAAKF,qBAAL,GAA6B,IAA7B;AACA,uBAAKI,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKhE,WAAL,CAAiBoE;AADL,mBAApB;AAGD,iBArBM,MAqBA,IACL,KAAKZ,KADA,EAEL;AACMF,+BADN,GACsB,KAAKrB,UAAL,CAAgBqB,aAAhB,EADtB;;AAEA,sBACE,KAAKI,qBAAL,KAA+BJ,aAA/B,KACC,CAAC,KAAK/C,WAAN,IAAqB,KAAKA,WAAL,CAAiB8D,MADvC,CADF,EAGE;AACA,yBAAKX,qBAAL,GAA6BJ,aAA7B;AACA,wBAAI,KAAKjD,eAAL,IAAwB,KAAKA,eAAL,CAAqBmD,KAAjD,EAAwD;AACtD,2BAAKnD,eAAL,CAAqBiE,YAArB;AACD;AACF;AACKb,4BAXN,GAWmB,KAAKxB,UAAL,CAAgBwB,UAAhB,EAXnB;;AAYA,sBACE,KAAKG,iBAAL,KAA2BH,UAA3B,KACC,CAAC,KAAKlD,WAAN,IAAqB,KAAKA,WAAL,CAAiB8D,MADvC,CADF,EAGE;AACA,yBAAKT,iBAAL,GAAyBH,UAAzB;AACA,wBAAI,KAAKnD,gBAAL,IAAyB,KAAKA,gBAAL,CAAsBkD,KAAnD,EAA0D;AACxD,2BAAKlD,gBAAL,CAAsBgE,YAAtB;AACD;AACF;;AAED,sBACE,KAAKX,mBAAL,KAA6B,KAAKvC,KADpC,EAEE;AACMmD,4BADN,GAEE,KAAKZ,mBAAL,IACA,KAAKA,mBAAL,CAAyBa,KAAzB,EAFe,IAGZ,EAJL;;;AAMA,yBAAKb,mBAAL,GAA2B,KAAKvC,KAAhC;;AAEA;AACA,wBAAI,KAAKnB,KAAL,IACAsE,SAASE,MAAT,KAAoB,CADpB,IAEA,KAAKrD,KAAL,CAAWqD,MAAX,KAAsB,CAFtB,IAGA,KAAKxE,KAAL,CAAWyE,gBAHX,IAIA,KAAKzE,KAAL,CAAWyE,gBAAX,CAA4BD,MAA5B,KAAuC,CAJ3C,EAI8C;AAC5C;AACA,2BAAKxE,KAAL,CAAW0E,qBAAX;AACD;;AAEGC,4BAlBJ,GAkBe,KAAK3E,KAAL,GAAa,KAAKA,KAAL,CAAWyE,gBAAX,CAA4B3C,IAA5B,CAAiCC,+BAAjC,CAAb,GAAiE,EAlBhF;AAmBA;;AACA,yBAAKZ,KAAL,CAAW+B,OAAX,CAAmB,UAAChE,IAAD,EAAU;AAC3B,0BAAM0F,eAAeN,SAASO,SAAT,CAAmB;AAAA,+BAAQC,KAAKrC,SAAL,KAAmBvD,KAAKuD,SAAhC;AAAA,uBAAnB,CAArB;AACA,0BAAImC,iBAAiB,CAAC,CAAtB,EAAyB;AACvB,4BAAI,OAAO,OAAKnE,UAAZ,KAA2B,UAA/B,EAA2C;AACzC,iCAAKA,UAAL,CAAgBvB,IAAhB;AACD;AACD,4BAAI,OAAO,OAAKsB,UAAZ,KAA2B,UAA3B,IAAyC,+BAAUtB,IAAV,CAA7C,EAA8D;AAC5D,iCAAKsB,UAAL,CAAgBtB,IAAhB;AACD;AACF,uBAPD,MAOO;AACL,4BAAM6F,UAAUT,SAASM,YAAT,CAAhB;AACAN,iCAASU,MAAT,CAAgBJ,YAAhB,EAA8B,CAA9B;AACA,4BACE1F,KAAK+F,eAAL,KAAyBF,QAAQE,eAAjC,IACA,OAAO,OAAKvE,cAAZ,KAA+B,UAFjC,EAGE;AACA,iCAAKA,cAAL,CAAoBxB,IAApB;AACD;AACF;AACDyF,+BAAS5G,IAAT,CAAc,UAACmH,MAAD,EAASC,KAAT,EAAmB;AAC/B,4BAAMC,WAAWlG,KAAKqD,SAAL,CAAexE,IAAf,CAAoB;AAAA,iCACnCsH,QAAQC,EAAR,KAAeJ,OAAOK,QADa;AAAA,yBAApB,CAAjB;AAGA,4BAAIH,aAAatH,SAAjB,EAA4B;AAC1B6G,qCAAW,OAAKa,cAAL,CAAoBL,KAApB,EAA2BR,QAA3B,CAAX;AACA,iCAAKc,eAAL,CAAqB;AACnBhD,uCAAWvD,KAAKuD,SADG;AAEnBiD,wCAAYN,SAASE;AAFF,2BAArB;AAIA,iCAAO,IAAP;AACD;AACD,+BAAO,KAAP;AACD,uBAbD;AAcD,qBAjCD;;AAmCAhB,6BAASpB,OAAT,CAAiB,UAAChE,IAAD,EAAU;AACzB,0BAAI,OAAO,OAAKyB,YAAZ,KAA6B,UAAjC,EAA6C;AAC3C,+BAAKA,YAAL,CAAkBzB,IAAlB;AACD;AACF,qBAJD;AAKD;AACF;;;;;;;;;;;;;;;;;;iCAEU;AAAA;;AACX,WAAK2E,KAAL,CAAW8B,SAAX,CAAqB;AAAA,eAAM,OAAKC,cAAL,EAAN;AAAA,OAArB;AACD;;;mCAEcT,K,EAAOR,Q,EAAU;AAC9BkB,cAAQC,GAAR,CAAY,gBAAZ,EAA8BX,KAA9B;AACAR,eAASK,MAAT,CAAgBG,KAAhB,EAAuB,CAAvB;AACAU,cAAQC,GAAR,CAAY,wBAAZ,EAAsCnB,QAAtC;AACA,aAAOA,QAAP;AACD;;;oCAEeoB,O,EAAS;AACvB,WAAKlC,KAAL,CAAWC,QAAX;AACEC,cAAM,KAAKhE,WAAL,CAAiBiG;AADzB,SAEKD,OAFL;AAID;;;wBAEqB;AACpB,aAAO,qCAAgB,KAAK5E,KAArB,CAAP;AACD;;;wBAEY;AACX,aAAO,KAAK8E,KAAL,CAAWC,MAAlB;AACD;;;wBAEW;AACV,aAAO,KAAKD,KAAL,CAAWC,MAAX,KAAsBC,yBAAe5C,KAA5C;AACD;;;wBAEa;AACZ,aAAO,KAAK0C,KAAL,CAAWC,MAAX,KAAsBC,yBAAevC,OAA5C;AACD;;;wBAEW;AACV,aAAO,KAAK5B,UAAL,CAAgBb,KAAhB,EAAP;AACD;;;wBAEiB;AAChB,aAAO,KAAKP,QAAL,CAAcwF,OAAd,CAAsB,KAAKvF,eAA3B,CAAP;AACD;;;wBAEqB;AACpB,aAAO,KAAKmB,UAAL,CAAgBqE,eAAhB,EAAP;AACD;;;wBAEuB;AACtB,aAAO,KAAKrE,UAAL,CAAgBsE,iBAAhB,EAAP;AACD;;;wBAEwB;AACvB,aAAO,KAAKtE,UAAL,CAAgBuE,kBAAhB,EAAP;AACD;;;wBAEsB;AACrB,aAAO,KAAKvE,UAAL,CAAgBwE,gBAAhB,EAAP;AACD;;;EAxYsCC,kB;kBAApB3H,W","file":"index.js","sourcesContent":["import 'core-js/fn/array/find';\nimport { Module } from '../../lib/di';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport actionTypes from './actionTypes';\nimport callDirections from '../../enums/callDirections';\nimport getCallMonitorReducer, {\n  getCallMatchedReducer\n} from './getCallMonitorReducer';\nimport normalizeNumber from '../../lib/normalizeNumber';\nimport {\n  isRinging,\n  hasRingingCalls,\n  sortByStartTime,\n} from '../../lib/callLogHelpers';\nimport ensureExist from '../../lib/ensureExist';\nimport { isRing, isOnHold } from '../Webphone/webphoneHelper';\n\nfunction matchWephoneSessionWithAcitveCall(sessions, callItem) {\n  if (!sessions || !callItem.sipData) {\n    return undefined;\n  }\n  return sessions.find((session) => {\n    if (session.direction !== callItem.direction) {\n      return false;\n    }\n    if (\n      session.direction === callDirections.inbound &&\n      callItem.sipData.remoteUri.indexOf(session.from) === -1\n    ) {\n      return false;\n    }\n    if (\n      session.direction === callDirections.outbound &&\n      callItem.sipData.remoteUri.indexOf(session.to) === -1\n    ) {\n      return false;\n    }\n    let webphoneStartTime;\n    if (session.direction === callDirections.inbound) {\n      webphoneStartTime = session.creationTime;\n    } else {\n      webphoneStartTime = session.startTime || session.creationTime;\n    }\n    // 16000 is from experience in test.\n    // there is delay bettween active call created and webphone session created\n    // for example, the time delay is decided by when webphone get invite info\n    if (\n      Math.abs(callItem.startTime - webphoneStartTime) > 16000\n    ) {\n      return false;\n    }\n    return true;\n  });\n}\n\n/**\n * @class\n * @description active calls monitor module\n */\n@Module({\n  deps: [\n    'AccountInfo',\n    'Storage',\n    'DetailedPresence',\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'Webphone', optional: true },\n    { dep: 'Call', optional: true },\n    { dep: 'ActivityMatcher', optional: true },\n    { dep: 'CallMonitorOptions', optional: true },\n    { dep: 'TabManager', optional: true },\n  ]\n})\nexport default class CallMonitor extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Call} params.call - call module instance\n   * @param {AccountInfo} params.accountInfo - accountInfo module instance\n   * @param {DetailedPresence} params.detailedPresence - detailedPresence module instance\n   * @param {ActivityMatcher} params.activityMatcher - activityMatcher module instance\n   * @param {ContactMatcher} params.contactMatcher - contactMatcher module instance\n   * @param {Webphone} params.webphone - webphone module instance\n   * @param {Storage} params.storage - storage module instance\n   * @param {Function} params.onRinging - function on ring\n   * @param {Function} params.onNewCall - function on new call\n   * @param {Function} params.onCallUpdated - function on call updated\n   * @param {Function} params.onCallEnded - function on call ended\n   */\n  constructor({\n    call,\n    accountInfo,\n    detailedPresence,\n    activityMatcher,\n    contactMatcher,\n    tabManager,\n    webphone,\n    onRinging,\n    onNewCall,\n    onCallUpdated,\n    onCallEnded,\n    storage,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._call = call;\n    this._accountInfo = this::ensureExist(accountInfo, 'accountInfo');\n    this._detailedPresence = this::ensureExist(detailedPresence, 'detailedPresence');\n    this._contactMatcher = contactMatcher;\n    this._activityMatcher = activityMatcher;\n    this._tabManager = tabManager;\n    this._webphone = webphone;\n    this._onRinging = onRinging;\n    this._onNewCall = onNewCall;\n    this._onCallUpdated = onCallUpdated;\n    this._onCallEnded = onCallEnded;\n    this._storage = this::ensureExist(storage, 'storage');\n    this._callMatchedKey = 'callMatched';\n\n    this._reducer = getCallMonitorReducer(this.actionTypes);\n\n    this._storage.registerReducer({\n      key: this._callMatchedKey,\n      reducer: getCallMatchedReducer(this.actionTypes),\n    });\n\n\n    this.addSelector('normalizedCalls',\n      () => this._detailedPresence.calls,\n      () => this._accountInfo.countryCode,\n      () => this._webphone && this._webphone.sessions,\n      (callsFromPresence, countryCode, sessions) => {\n        let sessionsCache = sessions;\n        return callsFromPresence.map((callItem) => {\n          // use account countryCode to normalize number due to API issues [RCINT-3419]\n          const fromNumber = normalizeNumber({\n            phoneNumber: callItem.from && callItem.from.phoneNumber,\n            countryCode,\n          });\n          const toNumber = normalizeNumber({\n            phoneNumber: callItem.to && callItem.to.phoneNumber,\n            countryCode,\n          });\n          const webphoneSession = matchWephoneSessionWithAcitveCall(sessionsCache, callItem);\n          sessionsCache = sessionsCache.filter(x => x !== webphoneSession);\n          return {\n            ...callItem,\n            from: {\n              phoneNumber: fromNumber,\n            },\n            to: {\n              phoneNumber: toNumber,\n            },\n            startTime: (\n              (webphoneSession && webphoneSession.startTime) ||\n              callItem.startTime\n            ),\n            webphoneSession,\n          };\n        }).sort(sortByStartTime);\n      },\n    );\n\n    this.addSelector('calls',\n      this._selectors.normalizedCalls,\n      () => (this._contactMatcher && this._contactMatcher.dataMapping),\n      () => (this._activityMatcher && this._activityMatcher.dataMapping),\n      () => (this.callMatched),\n      (normalizedCalls, contactMapping = {}, activityMapping = {}, callMatched) => {\n        const calls = normalizedCalls.map((callItem) => {\n          const fromNumber = callItem.from && callItem.from.phoneNumber;\n          const toNumber = callItem.to && callItem.to.phoneNumber;\n          const fromMatches = (fromNumber && contactMapping[fromNumber]) || [];\n          const toMatches = (toNumber && contactMapping[toNumber]) || [];\n          const toNumberEntity = callMatched[callItem.sessionId];\n          return {\n            ...callItem,\n            fromMatches,\n            toMatches,\n            activityMatches: (activityMapping[callItem.sessionId]) || [],\n            toNumberEntity,\n          };\n        });\n        return calls;\n      }\n    );\n\n    this.addSelector('activeRingCalls',\n      this._selectors.calls,\n      calls => calls.filter(callItem =>\n        callItem.webphoneSession && isRing(callItem.webphoneSession)\n      )\n    );\n\n    this.addSelector('activeOnHoldCalls',\n      this._selectors.calls,\n      calls => calls.filter(callItem =>\n        callItem.webphoneSession && isOnHold(callItem.webphoneSession)\n      )\n    );\n\n    this.addSelector('activeCurrentCalls',\n      this._selectors.calls,\n      calls => calls.filter(callItem =>\n        callItem.webphoneSession &&\n        !isOnHold(callItem.webphoneSession) &&\n        !isRing(callItem.webphoneSession)\n      )\n    );\n\n    this.addSelector('otherDeviceCalls',\n      this._selectors.calls,\n      () => this._webphone && this._webphone.lastEndedSessions,\n      (calls, lastEndedSessions) => {\n        let sessionsCache = lastEndedSessions;\n        return calls.filter((callItem) => {\n          if (callItem.webphoneSession) {\n            return false;\n          }\n          if (!sessionsCache) {\n            return true;\n          }\n          const endCall = matchWephoneSessionWithAcitveCall(sessionsCache, callItem);\n          sessionsCache = sessionsCache.filter(x => x !== endCall);\n          return !endCall;\n        });\n      },\n    );\n\n    this.addSelector('uniqueNumbers',\n      this._selectors.normalizedCalls,\n      (normalizedCalls) => {\n        const output = [];\n        const numberMap = {};\n        function addIfNotExist(number) {\n          if (!numberMap[number]) {\n            output.push(number);\n            numberMap[number] = true;\n          }\n        }\n        normalizedCalls.forEach((callItem) => {\n          if (callItem.from && callItem.from.phoneNumber) {\n            addIfNotExist(callItem.from.phoneNumber);\n          }\n          if (callItem.to && callItem.to.phoneNumber) {\n            addIfNotExist(callItem.to.phoneNumber);\n          }\n        });\n        return output;\n      }\n    );\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: this._selectors.uniqueNumbers,\n        readyCheckFn: () => (\n          this._accountInfo.ready &&\n          this._detailedPresence.ready\n        ),\n      });\n    }\n\n    this.addSelector('sessionIds',\n      () => this._detailedPresence.calls,\n      calls => calls.map(callItem => callItem.sessionId)\n    );\n\n    if (this._activityMatcher) {\n      this._activityMatcher.addQuerySource({\n        getQueriesFn: this._selectors.sessionIds,\n        readyCheckFn: () => this._detailedPresence.ready,\n      });\n    }\n\n    this._lastProcessedNumbers = null;\n    this._lastProcessedCalls = null;\n    this._lastProcessedIds = null;\n  }\n\n  async _onStateChange() {\n    if (\n      (!this._call || this._call.ready) &&\n      this._accountInfo.ready &&\n      this._detailedPresence.ready &&\n      (!this._contactMatcher || this._contactMatcher.ready) &&\n      (!this._activityMatcher || this._activityMatcher.ready) &&\n      (!this._tabManager || this._tabManager.ready) &&\n      this._storage.ready &&\n      this.pending\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      (\n        (this._call && !this._call.ready) ||\n        !this._accountInfo.ready ||\n        !this._detailedPresence.ready ||\n        (this._contactMatcher && !this._contactMatcher.ready) ||\n        (this._activityMatcher && !this._activityMatcher.ready) ||\n        (this._tabManager && !this._tabManager.ready) ||\n        !this._storage.ready\n      ) &&\n      this.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.reset,\n      });\n      this._lastProcessedCalls = null;\n      this._lastProcessedIds = null;\n      this._lastProcessedNumbers = null;\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    } else if (\n      this.ready\n    ) {\n      const uniqueNumbers = this._selectors.uniqueNumbers();\n      if (\n        this._lastProcessedNumbers !== uniqueNumbers &&\n        (!this._tabManager || this._tabManager.active)\n      ) {\n        this._lastProcessedNumbers = uniqueNumbers;\n        if (this._contactMatcher && this._contactMatcher.ready) {\n          this._contactMatcher.triggerMatch();\n        }\n      }\n      const sessionIds = this._selectors.sessionIds();\n      if (\n        this._lastProcessedIds !== sessionIds &&\n        (!this._tabManager || this._tabManager.active)\n      ) {\n        this._lastProcessedIds = sessionIds;\n        if (this._activityMatcher && this._activityMatcher.ready) {\n          this._activityMatcher.triggerMatch();\n        }\n      }\n\n      if (\n        this._lastProcessedCalls !== this.calls\n      ) {\n        const oldCalls = (\n          this._lastProcessedCalls &&\n          this._lastProcessedCalls.slice()\n        ) || [];\n\n        this._lastProcessedCalls = this.calls;\n\n        // no ringing calls\n        if (this._call &&\n            oldCalls.length !== 0 &&\n            this.calls.length === 0 &&\n            this._call.toNumberEntities &&\n            this._call.toNumberEntities.length !== 0) {\n          // console.log('no calls clean to number:');\n          this._call.cleanToNumberEntities();\n        }\n\n        let entities = this._call ? this._call.toNumberEntities.sort(sortByStartTime) : [];\n        // const matchedMap = {};\n        this.calls.forEach((call) => {\n          const oldCallIndex = oldCalls.findIndex(item => item.sessionId === call.sessionId);\n          if (oldCallIndex === -1) {\n            if (typeof this._onNewCall === 'function') {\n              this._onNewCall(call);\n            }\n            if (typeof this._onRinging === 'function' && isRinging(call)) {\n              this._onRinging(call);\n            }\n          } else {\n            const oldCall = oldCalls[oldCallIndex];\n            oldCalls.splice(oldCallIndex, 1);\n            if (\n              call.telephonyStatus !== oldCall.telephonyStatus &&\n              typeof this._onCallUpdated === 'function'\n            ) {\n              this._onCallUpdated(call);\n            }\n          }\n          entities.find((entity, index) => {\n            const toEntity = call.toMatches.find(toMatch =>\n              toMatch.id === entity.entityId\n            );\n            if (toEntity !== undefined) {\n              entities = this._removeMatched(index, entities);\n              this._setMatchedData({\n                sessionId: call.sessionId,\n                toEntityId: toEntity.id,\n              });\n              return true;\n            }\n            return false;\n          });\n        });\n\n        oldCalls.forEach((call) => {\n          if (typeof this._onCallEnded === 'function') {\n            this._onCallEnded(call);\n          }\n        });\n      }\n    }\n  }\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _removeMatched(index, entities) {\n    console.log('removeMatched:', index);\n    entities.splice(index, 1);\n    console.log('entities after splice:', entities);\n    return entities;\n  }\n\n  _setMatchedData(matched) {\n    this.store.dispatch({\n      type: this.actionTypes.setData,\n      ...matched,\n    });\n  }\n\n  get hasRingingCalls() {\n    return hasRingingCalls(this.calls);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get calls() {\n    return this._selectors.calls();\n  }\n\n  get callMatched() {\n    return this._storage.getItem(this._callMatchedKey);\n  }\n\n  get activeRingCalls() {\n    return this._selectors.activeRingCalls();\n  }\n\n  get activeOnHoldCalls() {\n    return this._selectors.activeOnHoldCalls();\n  }\n\n  get activeCurrentCalls() {\n    return this._selectors.activeCurrentCalls();\n  }\n\n  get otherDeviceCalls() {\n    return this._selectors.otherDeviceCalls();\n  }\n}\n"]}